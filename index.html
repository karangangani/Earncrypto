<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aether Mine</title>

  <!-- Telegram -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <!-- TON CONNECT -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css"/>

  <style>
    body{margin:0;background:#000;color:#fff;font-family:Arial;padding:15px;}
    .logo{text-align:center;font-size:40px;font-weight:900;color:#00ff88;text-shadow:0 0 15px #00ff88;}
    .stats{display:flex;justify-content:space-around;background:#111;padding:15px;border-radius:14px;margin-top:15px;}
    .value{font-size:24px;font-weight:bold;color:#00ff88;}
    .tab{flex:1;text-align:center;background:#222;margin:4px;padding:10px;border-radius:8px;}
    .tab.active{background:#00ff88;color:#000;}
    .section{display:none;background:#111;padding:15px;border-radius:12px;margin-top:15px;}
    .section.active{display:block;}
    .btn{background:#00ff88;color:#000;padding:16px;border:none;border-radius:10px;width:100%;margin-top:10px;font-weight:bold;font-size:18px;}
  </style>
</head>

<body>

  <div class="logo">AETHER</div>
  <div id="username" style="text-align:center;margin-top:10px;">Loading...</div>

  <div class="stats">
    <div><div class="value" id="points">0</div><small>Points</small></div>
    <div><div class="value" id="speed">1</div><small>pts/sec</small></div>
    <div><div class="value" id="refs">0</div><small>Refs</small></div>
  </div>

  <!-- Tabs -->
  <div style="display:flex;margin-top:15px;">
    <div class="tab active" onclick="openTab('home')">Home</div>
    <div class="tab" onclick="openTab('tasks')">Tasks</div>
    <div class="tab" onclick="openTab('referral')">Referral</div>
    <div class="tab" onclick="openTab('airdrop')">Airdrop</div>
  </div>

  <!-- HOME -->
  <div id="home" class="section active">
    <button class="btn" id="start-mining">Start Mining</button>
  </div>

  <!-- TASKS -->
  <div id="tasks" class="section">
    <button class="btn" id="watch-ad">Watch Ad (+50 pts)</button>
  </div>

  <!-- REFERRAL -->
  <div id="referral" class="section">
    <p>You have <span id="ref-count">0</span> referrals</p>
    <div id="ref-link" style="background:#222;padding:10px;border-radius:10px;word-break:break-all;"></div>
    <button class="btn" onclick="copyRef()">Copy Link</button>
  </div>

  <!-- AIRDROP -->
  <div id="airdrop" class="section">
    <h3>Airdrop â€“ 1 Jan 2026</h3>
    <button class="btn" id="connect-ton">Connect TON Wallet</button>
    <p id="wallet-status" style="color:#00ff88;margin-top:10px;">Not Connected</p>
  </div>

<script>
  /* ---------------- FIREBASE -------------------- */
  const firebaseConfig = {
    apiKey: "AIzaSyBRMiyuGkjDFfZE9tqgzGVWJalw_6Cypz4",
    authDomain: "earncryptomp.firebaseapp.com",
    projectId: "earncryptomp",
    storageBucket: "earncryptomp.firebasestorage.app",
    messagingSenderId: "405204250643",
    appId: "1:405204250643:web:8841299bceb46f6752cfe6"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  /* ------------- TELEGRAM INIT ---------------- */
  const tg = window.Telegram.WebApp;
  tg.ready();

  const user = tg.initDataUnsafe.user;
  const userId = user?.id.toString();
  const username = user?.username ? "@" + user.username : user?.first_name;

  /* ---------------- TON CONNECT ---------------- */
  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: "https://karangangani.github.io/Earncrypto/tonconnect-manifest.json",
    buttonRootId: "connect-ton"
  });

  let current = {
    points: 0,
    speed: 1,
    refs: [],
    wallet: "",
    refCode: "",
    adsWatchedToday: 0,
    lastAdTime: 0
  };

  /* ---------------- INIT APP ---------------- */
  auth.signInAnonymously().then(() => init());

  async function init() {
    document.getElementById("username").innerText = username;

    let doc = await db.collection("users").doc(userId).get();

    if (!doc.exists) {
      let refCode = "AM" + Math.random().toString(36).substr(2, 6).toUpperCase();
      await db.collection("users").doc(userId).set({
        telegramId: userId,
        username,
        refCode,
        points: 0,
        speed: 1,
        refs: [],
        wallet: "",
        adsWatchedToday: 0,
        lastAdTime: 0
      });
      current.refCode = refCode;
    } else {
      current = doc.data();
    }

    updateUI();
    generateRefLink();
    handleReferral();

    /* TON STATUS */
    tonConnectUI.onStatusChange(w => {
      if (w) {
        let addr = w.account.address;
        db.collection("users").doc(userId).update({ wallet: addr });
        document.getElementById("wallet-status").innerText =
          addr.slice(0,6)+"..."+addr.slice(-4);
      }
    });
  }
    /* ---------------- UPDATE UI ---------------- */
  function updateUI() {
    document.getElementById("points").innerText = current.points;
    document.getElementById("speed").innerText = current.speed;
    document.getElementById("refs").innerText = current.refs.length;
    document.getElementById("ref-count").innerText = current.refs.length;
  }

  /* ---------------- REFERRAL LINK ---------------- */
  function generateRefLink() {
    const bot = "AetherMineX";
    const link = `https://t.me/${bot}?start=ref_${current.refCode}`;
    document.getElementById("ref-link").innerText = link;
  }

  function copyRef() {
    navigator.clipboard.writeText(document.getElementById("ref-link").innerText);
    tg.showAlert("Referral link copied!");
  }

  /* ---------------- HANDLE REFERRAL ---------------- */
  async function handleReferral() {
    const params = new URLSearchParams(window.location.search);
    const s = params.get("start");

    if (s && s.startsWith("ref_")) {
      const code = s.replace("ref_", "");
      const snap = await db.collection("users").where("refCode", "==", code).get();

      if (!snap.empty) {
        const refId = snap.docs[0].id;

        if (refId !== userId && !current.refs.includes(userId)) {
          await db.collection("users").doc(refId).update({
            refs: firebase.firestore.FieldValue.arrayUnion(userId),
            points: firebase.firestore.FieldValue.increment(500)
          });

          tg.showAlert("Referral successful! Referrer +500 points.");
        }
      }
    }
  }

  /* ---------------- WATCH AD ---------------- */
  document.getElementById("watch-ad").onclick = async () => {
    const now = Date.now();
    const oneDay = 24 * 60 * 60 * 1000;

    if (now - current.lastAdTime > oneDay) {
      current.adsWatchedToday = 0;
    }

    if (current.adsWatchedToday >= 20) {
      tg.showAlert("Daily 20 ad limit reached. Come back tomorrow.");
      return;
    }

    current.adsWatchedToday++;
    current.lastAdTime = now;
    current.points += 50;

    await db.collection("users").doc(userId).update({
      adsWatchedToday: current.adsWatchedToday,
      lastAdTime: now,
      points: current.points
    });

    updateUI();
    tg.showAlert("You earned 50 points!");
  };

  /* ---------------- TABS ---------------- */
  function openTab(tab) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(tab).classList.add("active");
    event.target.classList.add("active");
  }
</script>
</body>
</html>

