<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aether MineX</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <!-- TON CONNECT UI -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css">
  <style>
    body { background:#000; color:#fff; font-family:Arial; padding:15px; margin:0; }
    .header { text-align:center; padding:20px; background:#111; border-radius:16px; }
    .logo { font-size:40px; font-weight:900; color:#fff; text-shadow:0 0 15px #fff; }
    .stats { display:flex; justify-content:space-around; background:#111; padding:15px; border-radius:12px; margin:15px 0; }
    .stat-value { font-size:24px; font-weight:bold; color:#fff; }
    .btn { background:#fff; color:#000; padding:16px; border:none; border-radius:12px; width:100%; margin:10px 0; font-weight:bold; font-size:18px; }
    .tab { flex:1; padding:12px; text-align:center; background:#222; margin:5px; border-radius:10px; }
    .tab.active { background:#fff; color:#000; }
    .section { display:none; background:#111; padding:15px; border-radius:12px; margin:10px 0; }
    .section.active { display:block; }
    #wallet-status { color:#fff; word-break:break-all; font-size:14px; }
    .task-item { background:#222; padding:10px; border-radius:10px; margin:10px 0; text-align:left; }
    .task-btn { width:auto; padding:8px 16px; }
    .level-bar { background:#333; height:8px; border-radius:4px; margin:10px 0; }
    .level-fill { background:#fff; height:100%; border-radius:4px; transition:width 0.3s; }
    .cooldown { color:#ff5555; font-size:12px; }
  </style>
</head>
<body>

  <div class="header">
    <div class="logo">Aether</div>
    <div id="username">Loading...</div>
    <div class="level-bar">
      <div class="level-fill" id="level-fill" style="width:0%;"></div>
    </div>
    <div style="font-size:14px;">Level <span id="level">1</span>/1000</div>
  </div>

  <div class="stats">
    <div><div class="stat-value" id="points">0</div><small>Coins</small></div>
    <div><div class="stat-value" id="speed">1</div><small>Level</small></div>
    <div><div class="stat-value" id="refs">0</div><small>Referrals</small></div>
  </div>

  <div style="display:flex;">
    <div class="tab active" onclick="openTab('home')">Home</div>
    <div class="tab" onclick="openTab('tasks')">Tasks</div>
    <div class="tab" onclick="openTab('referral')">Referral</div>
    <div class="tab" onclick="openTab('airdrop')">Airdrop</div>
  </div>

  <div id="home" class="section active">
    <p style="text-align:center;margin:20px 0;">Mine Coins by Completing Tasks!</p>
    <button class="btn" id="start-mining">Start Mining (1 coin/sec)</button>
    <p id="mining-status" style="color:#aaa;">Mining Stopped</p>
  </div>

  <div id="tasks" class="section">
    <div class="task-item">
      <h4>Watch Ad (+50 Coins)</h4>
      <p>Ads: <span id="ads-count">0</span>/20 | Cooldown: <span id="cooldown-timer">0</span>s</p>
      <button class="btn task-btn" id="watch-ad" disabled>Watch Ad</button>
      <div class="cooldown" id="cooldown-msg"></div>
    </div>
    <div class="task-item">
      <h4>Join Official Channel (+1000 Coins)</h4>
      <button class="btn task-btn" onclick="joinChannel()">Join Now</button>
      <p id="channel-status">Pending</p>
    </div>
  </div>

  <div id="referral" class="section">
    <p>You have <span id="ref-count">0</span> Referrals (+1000 Coins Each)</p>
    <div style="background:#222;padding:10px;border-radius:10px;word-break:break-all;" id="ref-link">Loading...</div>
    <button class="btn" onclick="copyRef()">COPY LINK</button>
  </div>

  <div id="airdrop" class="section">
    <h3>Airdrop: 1 Jan 2026</h3>
    <div id="countdown" style="color:#fff;font-size:18px;margin:15px 0;"></div>
    <button class="btn" id="connect-ton">Connect TON Wallet</button>
    <p id="wallet-status">Not Connected</p>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBRMiyuGkjDFfZE9tqgzGVWJalw_6Cypz4",
      authDomain: "earncryptomp.firebaseapp.com",
      projectId: "earncryptomp",
      storageBucket: "earncryptomp.firebasestorage.app",
      messagingSenderId: "405204250643",
      appId: "1:405204250643:web:8841299bceb46f6752cfe6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Telegram
    const tg = window.Telegram.WebApp;
    tg.ready();
    const user = tg.initDataUnsafe.user;
    const userId = user?.id?.toString() || 'test';
    const username = user?.username ? `@${user.username}` : user?.first_name;

    // TON Connect (Don't change - as per request)
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://raw.githubusercontent.com/ton-community/tutorials/main/03-client/test/public/tonconnect-manifest.json',
      buttonRootId: 'connect-ton'
    });

    let current = { points: 0, level: 1, refs: [], wallet: "", refCode: '', adsToday: 0, lastAdsReset: Date.now(), adsCooldown: 0, miningInterval: null };
    let isMining = false;

    async function init() {
      document.getElementById('username').innerText = username;

      const doc = await db.collection('users').doc(userId).get();
      if (!doc.exists) {
        const refCode = 'AM' + Math.random().toString(36).substr(2,6).toUpperCase();
        await db.collection('users').doc(userId).set({
          telegramId: userId, username, refCode, points: 0, level: 1, refs: [], wallet: "", adsToday: 0, lastAdsReset: Date.now()
        });
        current.refCode = refCode;
      } else {
        current = doc.data();
      }

      document.getElementById('ref-link').innerText = `https://t.me/AetherMineX?start=ref_${current.refCode || 'XXXX'}`;

      // TON Wallet Status
      tonConnectUI.onStatusChange(wallet => {
        if (wallet) {
          const tonAddress = wallet.account.address;
          db.collection('users').doc(userId).update({ wallet: tonAddress });
          document.getElementById('wallet-status').innerText = tonAddress.slice(0,6) + "..." + tonAddress.slice(-4);
        }
      });

      // Update Level Bar
      document.getElementById('level').innerText = current.level;
      document.getElementById('level-fill').style.width = `${(current.level / 1000) * 100}%`;

      updateUI();
      handleReferral();
      checkAdsCooldown();
      startCountdown();
    }
  function updateUI() {
      document.getElementById('points').innerText = current.points || 0;
      document.getElementById('refs').innerText = (current.refs || []).length;
      document.getElementById('ref-count').innerText = (current.refs || []).length;
    }

    async function handleReferral() {
      const params = new URLSearchParams(window.location.search);
      const ref = params.get('start');
      if (ref?.startsWith('ref_')) {
        const refCode = ref.split('_')[1];
        const snap = await db.collection('users').where('refCode', '==', refCode).get();
        if (!snap.empty && snap.docs[0].id !== userId) {
          const refId = snap.docs[0].id;
          await db.collection('users').doc(refId).update({ points: firebase.firestore.FieldValue.increment(1000) });
          current.refs = current.refs || [];
          if (!current.refs.includes(refId)) {
            current.refs.push(refId);
            await db.collection('users').doc(userId).update({ refs: current.refs });
          }
          tg.showAlert("Referral +1000 Coins!");
          updateUI();
        }
      }
    }

    function copyRef() {
      navigator.clipboard.writeText(document.getElementById('ref-link').innerText);
      tg.showAlert("Link Copied!");
    }

    function openTab(tab) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      event.target.classList.add('active');
    }

    // Mining
    document.getElementById('start-mining').onclick = () => {
      if (isMining) {
        clearInterval(current.miningInterval);
        isMining = false;
        document.getElementById('start-mining').innerText = 'Start Mining';
        document.getElementById('mining-status').innerText = 'Mining Stopped';
      } else {
        isMining = true;
        document.getElementById('start-mining').innerText = 'Stop Mining';
        document.getElementById('mining-status').innerText = 'Mining Active...';
        current.miningInterval = setInterval(() => {
          current.points += current.speed;
          db.collection('users').doc(userId).update({ points: current.points });
          updateUI();
        }, 1000);
      }
    };

    // Ads Task
    let adInterval = null;
    document.getElementById('watch-ad').onclick = async () => {
      if (current.adsToday >= 20 || current.adsCooldown > 0) return;

      document.getElementById('watch-ad').disabled = true;
      document.getElementById('watch-ad').innerText = 'Watching Ad...';

      try {
        await show_9903296();
        current.points += 50;
        current.adsToday++;
        db.collection('users').doc(userId).update({ points: current.points, adsToday: current.adsToday });
        tg.showAlert('Ad Watched! +50 Coins');
        updateUI();

        // 5 sec gap
        setTimeout(() => {
          document.getElementById('watch-ad').disabled = false;
          document.getElementById('watch-ad').innerText = 'Watch Ad (+50 Coins)';
        }, 5000);

      } catch (e) {
        tg.showAlert('Ad Failed! Try Again');
        document.getElementById('watch-ad').disabled = false;
        document.getElementById('watch-ad').innerText = 'Watch Ad (+50 Coins)';
      }
    };

    // Channel Join Task
    let channelClaimed = false;
    async function joinChannel() {
      if (channelClaimed) return;
      window.open('https://t.me/AetherMineX', '_blank');
      current.points += 1000;
      channelClaimed = true;
      db.collection('users').doc(userId).update({ points: current.points });
      tg.showAlert('Channel Joined! +1000 Coins');
      document.getElementById('join-channel').disabled = true;
      document.getElementById('join-channel').innerText = 'Claimed!';
      updateUI();
    }

    // Ads Cooldown Check
    function checkAdsCooldown() {
      const now = Date.now();
      const lastReset = current.lastAdsReset;
      if (now - lastReset > 3600000) { // 1 hour
        current.adsToday = 0;
        current.adsCooldown = 0;
        db.collection('users').doc(userId).update({ adsToday: 0, lastAdsReset: now });
      } else {
        current.adsCooldown = Math.ceil((3600000 - (now - lastReset)) / 1000);
      }

      document.getElementById('ads-count').innerText = current.adsToday;
      document.getElementById('cooldown-timer').innerText = current.adsCooldown;

      if (current.adsToday < 20 && current.adsCooldown === 0) {
        document.getElementById('watch-ad').disabled = false;
        document.getElementById('cooldown-msg').innerText = '';
      } else if (current.adsCooldown > 0) {
        document.getElementById('watch-ad').disabled = true;
        document.getElementById('cooldown-msg').innerText = `Cooldown: ${current.adsCooldown}s`;
        setTimeout(checkAdsCooldown, 1000);
      }
    }

    // Level Logic (1 referral + 10 ads = 1 level)
    async function updateLevel() {
      const referrals = current.refs ? current.refs.length : 0;
      const ads = current.adsToday; // Or total ads if tracked
      const newLevel = Math.min(1000, referrals + Math.floor(ads / 10));
      if (newLevel > current.level) {
        current.level = newLevel;
        current.speed = newLevel; // Speed = level
        db.collection('users').doc(userId).update({ level: newLevel, speed: newLevel });
        tg.showAlert(`Level Up! Level ${newLevel}`);
        document.getElementById('level').innerText = newLevel;
        document.getElementById('level-fill').style.width = `${(newLevel / 1000) * 100}%`;
      }
    }

    // Countdown for Airdrop
    function startCountdown() {
      const airdropDate = new Date('2026-01-01');
      setInterval(() => {
        const now = new Date();
        const diff = airdropDate - now;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        document.getElementById('countdown').innerText = `\( {days}d \){hours}h ${minutes}m`;
      }, 60000);
    }

    init();
    checkAdsCooldown();
    updateLevel(); // Initial check
  </script>
</body>
</html>
