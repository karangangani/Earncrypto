<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AETHER • Mini App (TON + Firebase + Ads + Referral)</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- TonConnect (UMD) -->
<script src="https://unpkg.com/@tonconnect/sdk/dist/tonconnect.umd.min.js"></script>

<!-- Monetag (YOUR exact ad sdk) - keep this ALWAYS -->
<script src='//libtl.com/sdk.js' data-zone='10192178' data-sdk='show_10192178'></script>

<style>
  /* Aether: professional dark theme */
  :root{
    --bg:#05060a; --panel:#0d1116; --muted:#9fb6c1; --accent:#00ff88; --accent2:#7c6cff;
    --radius:14px; --glass: rgba(255,255,255,0.02);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:radial-gradient(1200px 800px at 10% 10%, #07121a, #03040a);color:#e6f9f4;font-family:Inter,system-ui,Arial;padding:18px;min-height:100vh}
  .wrap{max-width:820px;margin:8px auto}
  .header{display:flex;gap:14px;align-items:center;padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.02)}
  /* coin 3D-ish using layered transforms */
  .coin-3d{width:92px;height:92px;border-radius:50%;background:conic-gradient(from 160deg,#0fffb0 0,#00c88a 40%, #7c6cff 100%);display:flex;align-items:center;justify-content:center;box-shadow:0 18px 40px rgba(0,255,136,0.08);position:relative;perspective:800px}
  .coin-inner{width:74px;height:74px;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,0.14),rgba(255,255,255,0.02));display:flex;align-items:center;justify-content:center;transform-style:preserve-3d;animation:spin 6s linear infinite}
  .coin-inner img{width:62%;height:62%;object-fit:contain}
  @keyframes spin{0%{transform:rotateY(0deg)}100%{transform:rotateY(360deg)}}
  .title h1{font-size:20px;margin:0}
  .title p{color:var(--muted);font-size:13px;margin-top:6px}
  .card{background:var(--panel);padding:14px;border-radius:14px;margin-top:12px;border:1px solid rgba(255,255,255,0.02)}
  .stats{display:flex;gap:12px}
  .stat{flex:1;padding:12px;background:var(--glass);border-radius:10px;text-align:center}
  .v{font-weight:900;color:var(--accent);font-size:20px}
  .l{color:var(--muted);font-size:12px;margin-top:6px}
  .tabs{display:flex;gap:8px;margin-top:12px}
  .tab{flex:1;padding:10px;border-radius:10px;text-align:center;cursor:pointer;color:var(--muted);border:1px solid rgba(255,255,255,0.01)}
  .tab.active{background:linear-gradient(90deg, rgba(0,255,136,0.06), rgba(124,108,255,0.03));color:var(--accent)}
  .section{display:none;padding-top:12px}
  .section.active{display:block}
  .btn{display:block;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#012;padding:12px;border-radius:12px;border:none;font-weight:800;cursor:pointer;width:100%}
  .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.02)}
  .hint{font-size:13px;color:var(--muted);margin-top:8px;text-align:center}
  .ref-box{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid rgba(255,255,255,0.02)}
  .ref-link{color:var(--accent);font-weight:800;word-break:break-all}
  .copy{background:#07121a;color:var(--accent);border-radius:8px;padding:8px 10px;border:none;cursor:pointer}
  .levels{margin-top:12px;max-height:420px;overflow:auto;padding-right:8px}
  .level{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.01);margin-bottom:8px;border:1px solid rgba(255,255,255,0.02)}
  .input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:#e6f9f4;margin-top:8px}
  .small{font-size:12px;color:var(--muted)}
  footer{margin-top:14px;text-align:center;color:var(--muted);font-size:12px}
  /* subtle button micro-anim */
  .btn:active{transform:translateY(1px) scale(0.998)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="coin-3d"><div class="coin-inner"><img id="logoImg" src="" alt="Aether"/></div></div>
      <div class="title">
        <h1>AETHER</h1>
        <p id="username">Loading...</p>
      </div>
    </div>

    <div class="card">
      <div class="stats">
        <div class="stat"><div class="v" id="points">0</div><div class="l">Points</div></div>
        <div class="stat"><div class="v" id="refs">0</div><div class="l">Referrals</div></div>
        <div class="stat"><div class="v" id="level">1</div><div class="l">Level</div></div>
      </div>

      <div class="tabs" style="margin-top:12px">
        <div class="tab active" onclick="openTab('home')">Home</div>
        <div class="tab" onclick="openTab('tasks')">Tasks</div>
        <div class="tab" onclick="openTab('ref')">Referral</div>
        <div class="tab" onclick="openTab('wallet')">Wallet</div>
      </div>

      <div id="home" class="section active">
        <div style="margin-top:12px">
          <button id="startEarn" class="btn">Start Earning</button>
          <p class="hint">Earn points by watching ads and inviting friends. Save TON wallet to claim tokens later.</p>
        </div>
      </div>

      <div id="tasks" class="section">
        <div style="margin-top:10px">
          <button id="watchAd" class="btn">Watch Rewarded Ad (+50)</button>
          <p class="small">Ads today: <span id="adsToday">0</span> / <span id="adsLimit">100</span></p>
          <div class="levels" id="levelsList"></div>
        </div>
      </div>

      <div id="ref" class="section">
        <div style="margin-top:12px">
          <p style="margin-bottom:8px">Invite friends — each valid referral = <strong>+500 pts</strong></p>
          <div class="ref-box">
            <div class="ref-link" id="refLink">Generating...</div>
            <div><button class="copy" id="copyBtn">COPY</button></div>
          </div>
          <p class="hint">Open the link inside Telegram for referral to register.</p>
        </div>
      </div>

      <div id="wallet" class="section">
        <div style="margin-top:12px">
          <div style="display:flex;gap:8px">
            <button id="connectBtn" class="btn">Connect Wallet</button>
            <button id="disconnectBtn" class="btn ghost">Disconnect</button>
          </div>
          <div class="hint" id="walletStatus" style="margin-top:10px">Not connected</div>
        </div>
      </div>

    </div>

    <footer>© AETHER — Bot: @AetherMineXBot</footer>
  </div>

<script>
/* ===================== CONFIG ===================== */
/* Put your small Aether logo url here (transparent bg preferred) */
const LOGO_URL = ""; // e.g. https://yourdomain.com/aether-icon.png
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBRMiyuGkjDFfZE9tqgzGVWJalw_6Cypz4",
  authDomain: "earncryptomp.firebaseapp.com",
  projectId: "earncryptomp",
  storageBucket: "earncryptomp.firebasestorage.app",
  messagingSenderId: "405204250643",
  appId: "1:405204250643:web:8841299bceb46f6752cfe6"
};
const BOT_USERNAME = "AetherMineXBot";
const REF_BONUS = 500;
const AD_REWARD = 50;
const LEVELS_COUNT = 100; // as requested
/* ================================================= */

/* set logo */
if (LOGO_URL) document.getElementById('logoImg').src = LOGO_URL;

/* Telegram WebApp */
const tg = window.Telegram && window.Telegram.WebApp;
if (tg) tg.ready();

/* Firebase init */
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
const auth = firebase.auth();

let firebaseUid = null;
let current = { points:0, refs:[], adsToday:0, adsMilestones:[], claimed:[], wallet:null, level:1, lastLogin:null, streak:0, username:null, telegramId:null };
let tonConnect = null;
try { tonConnect = new TonConnect.TonConnect({ manifestUrl: undefined }); } catch(e){ console.warn("TonConnect not loaded", e); }

/* detect start param from ?start or Telegram */
const startParam = (tg && (tg.initDataUnsafe.start_param || tg.initDataUnsafe.startapp)) || (new URLSearchParams(window.location.search).get('start') || new URLSearchParams(window.location.search).get('startapp')) || '';

/* sign-in anonymous */
auth.signInAnonymously().then(()=>{ firebaseUid = auth.currentUser.uid; initApp(); }).catch(e=>{ console.warn("auth fail", e); firebaseUid = "anon_"+Date.now(); initApp(); });

function userDoc(){ return db.collection('users').doc(firebaseUid); }

async function initApp(){
  // ensure user doc
  const doc = await userDoc().get();
  if (!doc.exists) {
    const refCode = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) ? tg.initDataUnsafe.user.id.toString() : firebaseUid;
    const uname = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? (tg.initDataUnsafe.user.username || tg.initDataUnsafe.user.first_name) : null;
    const tid = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) ? tg.initDataUnsafe.user.id.toString() : null;
    await userDoc().set({
      firebaseUid, telegramId: tid, username: uname, refCode, points:0, refs:[], adsToday:0, adsMilestones:[], claimed:[], wallet:null, level:1, lastLogin:null, streak:0, referredBy:null, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
    current = { points:0, refs:[], adsToday:0, adsMilestones:[], claimed:[], wallet:null, level:1, lastLogin:null, streak:0, username:uname, telegramId:tid };
  } else {
    current = doc.data();
  }

  // referral link (prefer Telegram id for BUGminer style)
  const refIdForLink = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) ? tg.initDataUnsafe.user.id.toString() : firebaseUid;
  const myLink = `https://t.me/${BOT_USERNAME}?startapp=ref_${refIdForLink}`;
  document.getElementById('refLink').innerText = myLink;
  document.getElementById('copyBtn').onclick = ()=>{ navigator.clipboard.writeText(myLink); if (tg) tg.showAlert("Link copied"); else alert("Copied"); };

  // handle incoming referral param
  await handleReferral();

  // realtime updates
  userDoc().onSnapshot(snap=>{
    if (!snap.exists) return;
    current = snap.data();
    refreshUI();
    renderLevels();
  });

  // initial UI render
  refreshUI();
  renderLevels();
  checkDailyLogin();
}

/* REFERRAL logic */
async function handleReferral(){
  try {
    if (!startParam || !startParam.startsWith('ref_')) return;
    const refId = startParam.split('_')[1]; if (!refId) return;
    const meSnap = await userDoc().get(); const meData = meSnap.exists ? meSnap.data() : {};
    if (meData.referredBy) return; // already referred
    // block self-referral
    if (refId === firebaseUid) return;
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id && refId === tg.initDataUnsafe.user.id.toString()) return;
    // try doc by id
    let refDocSnap = await db.collection('users').doc(refId).get();
    if (!refDocSnap.exists) {
      const q = await db.collection('users').where('telegramId','==',refId).limit(1).get();
      if (!q.empty) refDocSnap = q.docs[0];
      else { console.log("referrer not found", refId); return; }
    }
    const refDocId = refDocSnap.id;
    // credit referrer
    await db.collection('users').doc(refDocId).update({
      refs: firebase.firestore.FieldValue.arrayUnion(firebaseUid),
      points: firebase.firestore.FieldValue.increment(REF_BONUS)
    });
    // mark current as referred
    await userDoc().set({ referredBy: refDocId }, { merge:true });
    if (tg) tg.showAlert("Referral applied. Referrer +500 pts");
    else alert("Referral applied");
  } catch(e){ console.error("handleReferral err", e); }
}

/* UI refresh */
function refreshUI(){
  document.getElementById('points').innerText = Math.floor(current.points || 0);
  document.getElementById('refs').innerText = (current.refs || []).length;
  document.getElementById('level').innerText = current.level || 1;
  document.getElementById('adsToday').innerText = current.adsToday || 0;
  document.getElementById('adsLimit').innerText = 100 + ((current.refs && current.refs.length) || 0) * 2;
  document.getElementById('username').innerText = current.username || ((tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.first_name) || "Guest");
  document.getElementById('walletStatus').innerText = current.wallet ? `${current.wallet.slice(0,6)}...${current.wallet.slice(-4)}` : "Not connected";
}

/* tabs */
function openTab(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`[onclick="openTab('${id}')"]`).classList.add('active');
}

/* Levels */
function levelReq(n){ return { refs: Math.ceil(n/2), ads: n*5, reward: n*1000 }; }
function renderLevels(){
  const wrap = document.getElementById('levelsList'); if (!wrap) return;
  wrap.innerHTML = '';
  for (let i=1;i<=LEVELS_COUNT;i++){
    const r = levelReq(i);
    const refs = (current.refs && current.refs.length) || 0;
    const ads = current.adsToday || 0;
    const claimed = current.claimed || [];
    const eligible = refs >= r.refs && ads >= r.ads && !claimed.includes(i);
    const div = document.createElement('div'); div.className='level';
    div.innerHTML = `<div><strong>Level ${i}</strong><div style="font-size:12px;color:${'#9fb6c1'}">Req: ${r.refs} refs & ${r.ads} ads • Reward ${r.reward} pts</div></div>`;
    if (eligible) {
      const b = document.createElement('button'); b.className='btn'; b.textContent='Claim'; b.onclick = ()=>claimLevel(i);
      div.appendChild(b);
    } else {
      const p = document.createElement('div'); p.style.color='#9fb6c1'; p.style.fontSize='13px';
      p.textContent = `Progress: ${Math.min(refs,r.refs)}/${r.refs} refs • ${Math.min(ads,r.ads)}/${r.ads} ads`;
      div.appendChild(p);
    }
    wrap.appendChild(div);
  }
}
  /* claimLevel */
async function claimLevel(i){
  const r = levelReq(i); const refs = (current.refs && current.refs.length) || 0; const ads = current.adsToday || 0; const claimed = current.claimed || [];
  if (refs < r.refs || ads < r.ads) return (tg ? tg.showAlert("Not eligible") : alert("Not eligible"));
  if (claimed.includes(i)) return (tg ? tg.showAlert("Already claimed") : alert("Already claimed"));
  current.points = (current.points || 0) + r.reward; claimed.push(i); current.claimed = claimed; if (i > (current.level || 1)) current.level = i;
  await userDoc().update({ points: current.points, claimed: current.claimed, level: current.level });
  if (tg) tg.showAlert(`Level ${i} claimed: +${r.reward} pts`);
}

/* Ads flow - uses Monetag snippet you insisted on (show_10192178) */
let adLock=false;
document.getElementById('watchAd').onclick = async ()=>{
  if (adLock) return;
  const limit = 100 + ((current.refs && current.refs.length) || 0) * 2;
  if ((current.adsToday || 0) >= limit) return (tg ? tg.showAlert("Daily ad limit") : alert("Daily ad limit"));
  adLock=true; const btn=document.getElementById('watchAd'); btn.disabled=true; btn.innerText='Loading Ad...';
  try {
    // EXACT Monetag usage (your snippet)
    await show_10192178('pop').then(async ()=>{
      // rewarded: on success
      current.points = (current.points||0) + AD_REWARD;
      current.adsToday = (current.adsToday||0) + 1;
      const milestones = {10:500,20:1000,50:3000};
      if (milestones[current.adsToday] && !(current.adsMilestones||[]).includes(current.adsToday)){
        current.points += milestones[current.adsToday];
        current.adsMilestones = current.adsMilestones || []; current.adsMilestones.push(current.adsToday);
      }
      await userDoc().update({ points: current.points, adsToday: current.adsToday, adsMilestones: current.adsMilestones });
      if (tg) tg.showAlert(`+${AD_REWARD} pts`);
    }).catch(e=>{
      // ad failed/closed
      if (tg) tg.showAlert("Ad not completed");
    });
  } catch(e){ console.error("ad error", e); if (tg) tg.showAlert("Ad error"); }
  finally { btn.disabled=false; btn.innerText='Watch Rewarded Ad (+50)'; adLock=false; }
};

/* Start earning (passive) */
let earning=false;
document.getElementById('startEarn').onclick = ()=>{
  if (earning) return;
  earning=true;
  setInterval(async ()=>{
    current.points = (current.points||0) + 1;
    await userDoc().update({ points: current.points }).catch(()=>{});
  },1000);
  if (tg) tg.showAlert("Earning started");
};

/* Daily login bonus */
async function checkDailyLogin(){
  try {
    const today = new Date().toDateString();
    if (current.lastLogin !== today) {
      const streak = (current.streak || 0) % 7;
      const bonuses = [100,150,200,300,500,700,1000];
      const add = bonuses[streak] || 100;
      current.points = (current.points||0) + add;
      current.streak = (current.streak||0) + 1;
      current.lastLogin = today;
      await userDoc().update({ points: current.points, streak: current.streak, lastLogin: today, adsToday:0, adsMilestones:[] });
      if (tg) tg.showAlert(`Daily +${add} pts`);
    }
  } catch(e){ console.error("daily err", e); }
}

/* WALLET: try Telegram wallet -> TonConnect -> Manual paste */
async function tryTelegramWallet(){
  try {
    if (!tg) throw new Error("No Telegram WebApp");
    if (typeof tg.requestWallet === 'function') {
      try {
        await tg.requestWallet();
        // some clients fill initDataUnsafe.wallet
        const maybe = (tg.initDataUnsafe && (tg.initDataUnsafe.wallet || (tg.initDataUnsafe.user && tg.initDataUnsafe.user.wallet))) || null;
        if (maybe) return maybe;
        await new Promise(r=>setTimeout(r,700));
        const after = (tg.initDataUnsafe && (tg.initDataUnsafe.wallet || (tg.initDataUnsafe.user && tg.initDataUnsafe.user.wallet))) || null;
        if (after) return after;
      } catch(e){ console.warn("tg.requestWallet error", e); }
    }
  } catch(e){ console.warn("telegram wallet err", e); }
  return null;
}

async function tryTonConnect(){
  try {
    if (!tonConnect) throw new Error("TonConnect not loaded");
    // connector = tonConnect
    await tonConnect.connect();
    // accounts array
    const accs = tonConnect.accounts || [];
    if (accs.length) {
      // TonConnect account object may be {address, network}
      return accs[0].address || accs[0];
    }
    // try getAccount
    try { const acc = await tonConnect.getAccount(); if (acc && acc.address) return acc.address; } catch(e){}
  } catch(e){ console.warn("TonConnect error", e); }
  return null;
}

let tonSessionActive = false;
document.getElementById('connectBtn').onclick = async ()=>{
  // 1. Telegram in-app wallet
  const tw = await tryTelegramWallet();
  if (tw) { await saveWallet(tw); if (tg) tg.showAlert("Telegram wallet connected"); return; }

  // 2. TonConnect
  const tc = await tryTonConnect();
  if (tc) { await saveWallet(tc); tonSessionActive=true; if (tg) tg.showAlert("Wallet connected (TonConnect)"); return; }

  // 3. manual paste
  const p = prompt("Paste your TON wallet address here:");
  if (p) { await saveWallet(p.trim()); if (tg) tg.showAlert("Wallet saved (manual)"); return; }
};

document.getElementById('disconnectBtn').onclick = async ()=>{
  try {
    // kill tonConnect session if present
    if (tonConnect && tonSessionActive && typeof tonConnect.disconnect === 'function') {
      try { await tonConnect.disconnect(); } catch(_) {}
      tonSessionActive = false;
    }
    // clear wallet from firestore
    current.wallet = null;
    await userDoc().update({ wallet: null });
    refreshUI();
    if (tg) tg.showAlert("Disconnected");
  } catch(e){ console.error("disconnect err", e); if (tg) tg.showAlert("Error disconnecting"); }
};

async function saveWallet(addr){
  if (!addr) return;
  current.wallet = addr;
  try { await userDoc().update({ wallet: addr }); } catch(e){ console.error("saveWallet err", e); }
}

/* end */
console.log("Aether MiniApp loaded. Check console for debug.");
</script>
</body>
</html>

  
