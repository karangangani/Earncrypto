<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AETHER â€” Earn & Airdrop</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- TON Connect -->
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css"/>

<!-- Ads -->
<script src='//libtl.com/sdk.js' data-zone='10192178' data-sdk='show_10192178'></script>

<style>
:root{ --bg:#000; --panel:#0b0d0f; --muted:#9aa0a6; --accent:#fff; --green:#00d38a }
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,Arial,sans-serif;background:linear-gradient(180deg,#000,#070707);color:var(--muted);padding:14px;min-height:100vh;position:relative;overflow-x:hidden}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 80%, rgba(0,211,138,0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255,255,255,0.05) 0%, transparent 50%);z-index:-1;animation:logoPulse 4s ease-in-out infinite}
@keyframes logoPulse{0%,100%{opacity:0.5;transform:scale(1)}50%{opacity:1;transform:scale(1.05)}}
.wrap{max-width:720px;margin:12px auto;position:relative;z-index:1}
.header{display:flex;gap:12px;align-items:center;padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.03)}
.logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#111,#222);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:900;position:relative}
.logo::after{content:'Ae';position:absolute;font-size:24px;font-weight:900;color:var(--green);text-shadow:0 0 10px var(--green);animation:glow 2s ease-in-out infinite alternate}
@keyframes glow{from{text-shadow:0 0 5px var(--green)}to{text-shadow:0 0 20px var(--green),0 0 30px var(--green)}}
h1{color:var(--accent);font-size:18px;margin-bottom:2px}
.sub{color:var(--muted);font-size:13px}
.card{background:var(--panel);padding:14px;border-radius:12px;margin-top:12px;border:1px solid rgba(255,255,255,0.02)}
.stats{display:flex;gap:10px}
.stat{flex:1;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;text-align:center}
.v{font-weight:800;color:var(--accent);font-size:18px}
.tabs{display:flex;gap:8px;margin-top:12px}
.tab{flex:1;padding:10px;border-radius:10px;text-align:center;background:transparent;border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--muted)}
.tab.active{background:rgba(255,255,255,0.02);color:var(--accent)}
.section{display:none;padding-top:12px}
.section.active{display:block}
button.btn{width:100%;padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,#fff,#dfeaf6);color:#071018;font-weight:800;cursor:pointer}
button.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
button.enabled{background:var(--green);color:#001;}
.small{font-size:13px;color:var(--muted);margin-top:8px;text-align:center}
.ref-box{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);word-break:break-word;overflow-wrap:break-word}
.levels{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-top:12px}
.level{padding:10px;border-radius:8px;background:rgba(255,255,255,0.01)}
.claimBtn{background:var(--green);color:#001;padding:8px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.footer{margin-top:18px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>

<div class="wrap" id="mainContent">
  <div class="header">
    <div class="logo"></div>
    <div>
      <h1>AETHER â€” Earn & Airdrop</h1>
      <div id="userLine" class="sub">Loading...</div>
    </div>
  </div>

  <div class="card">
    <div class="stats">
      <div class="stat"><div class="v" id="points">0</div><div class="l">Coins</div></div>
      <div class="stat"><div class="v" id="refs">0</div><div class="l">Referrals</div></div>
      <div class="stat"><div class="v" id="level">1</div><div class="l">Level</div></div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="openTab('home')">Home</div>
      <div class="tab" onclick="openTab('tasks')">Tasks</div>
      <div class="tab" onclick="openTab('referral')">Referral</div>
      <div class="tab" onclick="openTab('airdrop')">Airdrop</div>
    </div>

    <!-- HOME -->
    <div id="home" class="section active">
      <div style="display:flex;gap:10px;align-items:center">
        <div style="flex:1">
          <button id="startMining" class="btn">Start Earning (Passive)</button>
          <p class="small">Daily login streak gives bonus. Claim level rewards in Tasks.</p>

          <div style="margin-top:16px">
            <button id="enableNotifications" class="btn">Enable Notifications & Get +100 Coins Bonus</button>
            <p class="small">Get airdrop alerts, daily bonuses, new features instantly + instant 100 coins reward!</p>
          </div>
        </div>
        <div style="width:88px;text-align:center">
          <div style="width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#111,#222);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:800">Ae</div>
        </div>
      </div>
    </div>

    <!-- TASKS -->
    <div id="tasks" class="section">
      <button id="watchAd" class="btn">Watch Rewarded Ad (+50)</button>
      <p class="small">Daily ads watched: <span id="adsToday">0</span> / <span id="adsLimit">20</span> | Total ads: <span id="totalAds">0</span></p>

      <div style="margin-top:12px" class="ref-box">
        <div>Join our channel (no coins):</div>
        <button id="openChannel" class="ghost">Open Channel</button>
      </div>

      <div class="small" style="margin-top:10px">Levels (claimable rewards):</div>
      <div id="levelsList" class="levels"></div>
      <div style="margin-top:10px;text-align:center"><button id="showAllLevels" class="ghost">Show More Levels</button></div>
    </div>

    <!-- REFERRAL -->
    <div id="referral" class="section">
      <div style="margin-bottom:8px">Invite friends â€” each successful referral = <strong>+500 coins</strong></div>
      <div class="ref-box">
        <div id="myRef" style="color:var(--accent);word-break:break-word;white-space:normal;overflow-wrap:break-word">Generating...</div>
        <div><button id="copyRef" class="ghost">COPY</button></div>
      </div>
      <p class="small" style="margin-top:8px">Only first-time joins via your link count. Unique ref code shown in header.</p>
    </div>

    <!-- AIRDROP -->
    <div id="airdrop" class="section">
      <div style="display:flex;gap:8px">
        <div style="flex:1"><button id="connectTon" class="btn">Connect TON Wallet</button></div>
        <div style="width:140px"><div id="tonBtnRoot"></div></div>
      </div>
      <div class="small" id="walletStatus">Aether - Not Connected</div>
      <div style="margin-top:12px"><button id="showBalance" class="ghost">Show Connected TON Address</button></div>
      <p class="small" style="margin-top:8px">Eligibility for airdrop: 10 referrals + 5000 coins. Airdrop date: Jan 1, 2026 â€” wallet changes blocked 7 days before airdrop.</p>
    </div>

  </div>
  <div class="footer">Â© Aether â€” Bot: @AetherMineXBot</div>
</div>

<script>
/* ========== CONFIG ========== */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBRMiyuGkjDFfZE9tqgzGVWJalw_6Cypz4",
  authDomain: "earncryptomp.firebaseapp.com",
  projectId: "earncryptomp",
  storageBucket: "earncryptomp.firebasestorage.app",
  messagingSenderId: "405204250643",
  appId: "1:405204250643:web:8841299bceb46f6752cfe6"
};
const AD_FN = 'show_10192178';
const DAILY_BASE = 20;
const ADS_COOLDOWN_MS = 5000;
const LEVELS_MAX = 1000;
const LEVEL_RENDER_CHUNK = 50;
const TON_MANIFEST = 'https://karangangani.github.io/Earncrypto/tonconnect-manifest.json';
const AIRDROP_DATE = new Date('2026-01-01T00:00:00Z');
/* ============================ */

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
const auth = firebase.auth();

const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const tgUser = tg.initDataUnsafe.user || {};
let userDocId = null;
let current = {
  coins: 0, refs: [], level: 1, adsToday: 0, totalAds: 0, adsMilestones: [], claimedLevels: [], tonWallet: '', lastWalletChange: 0, lastLogin: null, streak: 0, joinedChannel: false, refCode: '', telegramId: '', referredBy: null, username: '', notificationsEnabled: false
};
let tonUI = null;
let adLastTime = 0;
let levelsRendered = 0;
let unsubscribeSnapshot = null;

const startParam = tg.initDataUnsafe.start_param || '';

function userRef() { return db.collection('users').doc(userDocId); }

async function initApp() {
  try {
    await auth.signInAnonymously();

    const tgId = tgUser.id ? tgUser.id.toString() : ('guest_' + Date.now()).toString();
    userDocId = tgId;

    let doc = await userRef().get();
    let isNewUser = !doc.exists;
    let displayName = tgUser.username ? '@' + tgUser.username : (tgUser.first_name || 'Guest');
    current.username = displayName;

    if (isNewUser) {
      current.refCode = 'ref_' + Math.floor(Math.random() * 9000000 + 1000000);
      current.telegramId = tgId;
      current.notificationsEnabled = false;
      await userRef().set({
        telegramId: tgId,
        username: displayName,
        refCode: current.refCode,
        coins: 20,
        refs: [],
        level: 1,
        adsToday: 0,
        totalAds: 0,
        adsMilestones: [],
        claimedLevels: [],
        tonWallet: '',
        lastWalletChange: 0,
        lastLogin: null,
        streak: 0,
        joinedChannel: false,
        referredBy: null,
        notificationsEnabled: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      current.coins = 20;
    } else {
      const data = doc.data();
      Object.assign(current, {
        coins: data.coins || 0,
        refs: data.refs || [],
        level: data.level || 1,
        adsToday: data.adsToday || 0,
        totalAds: data.totalAds || 0,
        adsMilestones: data.adsMilestones || [],
        claimedLevels: data.claimedLevels || [],
        tonWallet: data.tonWallet || '',
        lastWalletChange: data.lastWalletChange || 0,
        lastLogin: data.lastLogin || null,
        streak: data.streak || 0,
        joinedChannel: data.joinedChannel || false,
        refCode: data.refCode || 'ref_' + Math.floor(Math.random() * 9000000 + 1000000),
        telegramId: data.telegramId || tgId,
        referredBy: data.referredBy || null,
        username: data.username || displayName,
        notificationsEnabled: data.notificationsEnabled || false
      });
    }
    document.getElementById('userLine').innerText = current.username + ' â€¢ ' + (current.refCode ? current.refCode.split('_')[1] : '---');

    if (unsubscribeSnapshot) unsubscribeSnapshot();
    unsubscribeSnapshot = userRef().onSnapshot((docSnap) => {
      if (!docSnap.exists) return;
      const data = docSnap.data();
      Object.assign(current, data);
      const newLevel = Math.min(Math.floor(((data.refs?.length || 0) + (data.totalAds || 0) / 10) / 10) + 1, LEVELS_MAX);
      if (newLevel > current.level) {
        current.level = newLevel;
        userRef().update({ level: newLevel });
      }
      updateUI();
      updateLevelProgressUI();
      updateNotificationButton();
    });

    // Referral link with ?start= to auto open bot chat
    const refLink = 'https://t.me/AetherMineXBot?start=' + current.refCode;
    document.getElementById('myRef').innerText = refLink;
    document.getElementById('copyRef').onclick = () => {
      navigator.clipboard.writeText(refLink).then(() => tg.showAlert('Copied! Share for +500 coins each'));
    };

    // Auto open bot chat for permission (background)
    setTimeout(() => {
      tg.openTelegramLink('https://t.me/AetherMineXBot');
    }, 2000);

    // TON Connect
    tonUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: TON_MANIFEST,
      buttonRootId: 'tonBtnRoot'
    });
    tonUI.onStatusChange(async (wallet) => {
      if (wallet?.account?.address) {
        await trySaveTonWallet(wallet.account.address);
        tg.showAlert('Connected to Aether!');
      } else {
        await userRef().update({ tonWallet: '', lastWalletChange: 0 });
        tg.showAlert('Disconnected');
      }
    });

    document.getElementById('connectTon').onclick = () => tonUI.connectWallet();
    document.getElementById('watchAd').onclick = watchAdHandler;
    document.getElementById('openChannel').onclick = () => tg.openTelegramLink('https://t.me/AetherMineX');
    document.getElementById('startMining').onclick = startPassiveMining;
    document.getElementById('showAllLevels').onclick = () => renderLevelsChunk(100);
    document.getElementById('showBalance').onclick = () => {
      if (!current.tonWallet) return tg.showAlert('Connect wallet first');
      tg.showAlert('TON Address: ' + current.tonWallet);
    };
    document.getElementById('enableNotifications').onclick = enableNotificationsHandler;

    if (startParam && startParam.startsWith('ref_') && isNewUser) {
      await handleReferralParam(startParam);
    }

    renderLevelsChunk(LEVEL_RENDER_CHUNK);
    await checkDailyLogin();
    updateUI();
    updateNotificationButton();

    if (isNewUser) tg.showAlert('Welcome to Aether! Share link for +500 coins each ðŸš€');

  } catch (error) {
    console.error('Init error:', error);
    tg.showAlert('Error loading app. Please retry.');
  }
}

async function enableNotificationsHandler() {
  if (!tg) return;
  try {
    const granted = await tg.requestWriteAccess();
    if (granted) {
      await userRef().update({
        notificationsEnabled: true,
        coins: firebase.firestore.FieldValue.increment(100)
      });
      current.coins += 100;
      current.notificationsEnabled = true;
      updateUI();
      updateNotificationButton();
      tg.showAlert('âœ… Notifications enabled!\n+100 coins bonus!\n\nImportant: Do not delete bot chat to keep receiving updates.');
    } else {
      tg.showAlert('Permission denied. You can enable anytime.');
    }
  } catch (e) {
    tg.showAlert('Failed. Try again.');
  }
}

function updateNotificationButton() {
  const btn = document.getElementById('enableNotifications');
  if (current.notificationsEnabled) {
    btn.innerText = 'Notifications Enabled âœ“ (+100 coins claimed)';
    btn.disabled = true;
    btn.classList.add('enabled');
  } else {
    btn.innerText = 'Enable Notifications & Get +100 Coins Bonus';
    btn.disabled = false;
    btn.classList.remove('enabled');
  }
}

async function handleReferralParam(param) {
  try {
    const referrerId = param.replace('ref_', '');
    if (!referrerId) return;
    const referrerDoc = await db.collection('users').doc(referrerId).get();
    if (!referrerDoc.exists) return;

    await userRef().update({ refs: firebase.firestore.FieldValue.arrayUnion(referrerId) });
    await db.collection('users').doc(referrerId).update({ refs: firebase.firestore.FieldValue.arrayUnion(userDocId) });
    await userRef().update({ coins: firebase.firestore.FieldValue.increment(500) });
    await db.collection('users').doc(referrerId).update({ coins: firebase.firestore.FieldValue.increment(500) });

    current.refs.push(referrerId);
    current.coins += 500;
    updateUI();
    tg.showAlert('Referral success! +500 coins each ðŸŽ‰');
  } catch (e) {
    console.error('Referral error:', e);
  }
}

const BONUS = [100,200,300,400,500,700,1000];
async function checkDailyLogin() {
  try {
    const today = new Date().toDateString();
    if (current.lastLogin === today) return;
    const streak = ((current.streak || 0) % 7) + 1;
    const bonus = BONUS[streak - 1] || 100;
    await userRef().update({
      coins: firebase.firestore.FieldValue.increment(bonus),
      streak,
      lastLogin: today,
      adsToday: 0,
      adsMilestones: []
    });
    current.coins += bonus;
    updateUI();
    tg.showAlert('Daily streak bonus: +' + bonus + ' coins! ðŸ”¥');
  } catch (e) { console.error(e); }
}

function updateUI() {
  document.getElementById('points').innerText = Math.floor(current.coins || 0);
  document.getElementById('refs').innerText = current.refs?.length || 0;
  document.getElementById('level').innerText = current.level || 1;
  document.getElementById('adsToday').innerText = current.adsToday || 0;
  document.getElementById('totalAds').innerText = current.totalAds || 0;
  const dailyLimit = DAILY_BASE + Math.max(0, (current.level || 1) - 1) * 20;
  document.getElementById('adsLimit').innerText = dailyLimit;
  document.getElementById('walletStatus').innerText = current.tonWallet ? `Aether - \( {current.tonWallet.slice(0,6)}... \){current.tonWallet.slice(-4)}` : 'Aether - Not Connected';
  document.getElementById('userLine').innerText = current.username + ' â€¢ ' + (current.refCode ? current.refCode.split('_')[1] : '---');
}

function openTab(tab) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
}

let mining = false;
function startPassiveMining() {
  if (mining) return tg.showAlert('Already mining!');
  mining = true;
  document.getElementById('startMining').innerText = 'Mining Active...';
  setInterval(async () => {
    if (!mining) return;
    await userRef().update({ coins: firebase.firestore.FieldValue.increment(1) });
    current.coins += 1;
    updateUI();
  }, 2000);
  tg.showAlert('Passive mining started! +1 coin every 2s');
}
  async function watchAdHandler() {
  const now = Date.now();
  const dailyLimit = DAILY_BASE + Math.max(0, (current.level || 1) - 1) * 20;
  if (current.adsToday >= dailyLimit) return tg.showAlert('Daily ad limit reached');
  if (now - adLastTime < ADS_COOLDOWN_MS) return tg.showAlert('Wait 5 seconds');
  adLastTime = now;

  const btn = document.getElementById('watchAd');
  btn.disabled = true;
  btn.innerText = 'Loading Ad...';

  try {
    if (typeof window[AD_FN] === 'function') await window[AD_FN]('pop');
    else await new Promise(r => setTimeout(r, 1500));
    await grantAdReward();
  } catch (e) {
    tg.showAlert('Ad not completed');
  }
  btn.disabled = false;
  btn.innerText = 'Watch Rewarded Ad (+50)';
}

async function grantAdReward() {
  await userRef().update({
    coins: firebase.firestore.FieldValue.increment(50),
    adsToday: firebase.firestore.FieldValue.increment(1),
    totalAds: firebase.firestore.FieldValue.increment(1)
  });
  current.coins += 50;
  current.adsToday += 1;
  current.totalAds += 1;
  updateUI();
  tg.showAlert('+50 coins!');
}

async function trySaveTonWallet(addr) {
  const now = Date.now();
  const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
  if (AIRDROP_DATE - now <= sevenDaysMs) return tg.showAlert('Wallet locked 7 days before airdrop');
  if (current.lastWalletChange && (now - current.lastWalletChange) < 12 * 60 * 60 * 1000) return tg.showAlert('Wait 12 hours');
  await userRef().update({ tonWallet: addr, lastWalletChange: now });
  current.tonWallet = addr;
  updateUI();
  tg.showAlert('Wallet connected!');
}

function renderLevelsChunk(max) {
  const container = document.getElementById('levelsList');
  const start = levelsRendered + 1;
  const end = Math.min(LEVELS_MAX, levelsRendered + max);
  for (let i = start; i <= end; i++) {
    const refsNeeded = i * 2; // Level 1: 2 refs, Level 2: 4 refs, etc.
    const adsNeeded = 10 + i * 5; // Level 1: 15 ads, Level 2: 20 ads, etc.
    const reward = 500 * i;
    const el = document.createElement('div');
    el.className = 'level';
    el.innerHTML = `
      <div style="font-weight:800;color:var(--accent)">Level ${i}</div>
      <div class="small">Requires: \( {refsNeeded} referrals & \){adsNeeded} total ads â€” Reward ${reward} coins</div>
      <div style="margin-top:8px"><button id="claim_${i}" class="claimBtn" disabled>Claim</button></div>
    `;
    container.appendChild(el);
    document.getElementById(`claim_${i}`).onclick = () => claimLevel(i, refsNeeded, adsNeeded, reward);
  }
  levelsRendered = end;
  updateLevelProgressUI();
}

async function updateLevelProgressUI() {
  const refsCount = current.refs?.length || 0;
  const adsDone = current.totalAds || 0;
  for (let i = 1; i <= levelsRendered; i++) {
    const btn = document.getElementById(`claim_${i}`);
    if (!btn) continue;
    const refsNeeded = i * 2;
    const adsNeeded = 10 + i * 5;
    const claimed = current.claimedLevels?.includes(i);
    btn.disabled = claimed || !(refsCount >= refsNeeded && adsDone >= adsNeeded);
    btn.innerText = claimed ? 'Claimed' : 'Claim';
  }
}

async function claimLevel(levelNo, refsNeeded, adsNeeded, reward) {
  const refsCount = current.refs?.length || 0;
  const adsDone = current.totalAds || 0;
  if (refsCount < refsNeeded || adsDone < adsNeeded) return tg.showAlert('Requirements not met');
  if (current.claimedLevels?.includes(levelNo)) return tg.showAlert('Already claimed');
  await userRef().update({
    coins: firebase.firestore.FieldValue.increment(reward),
    claimedLevels: firebase.firestore.FieldValue.arrayUnion(levelNo)
  });
  current.coins += reward;
  current.claimedLevels.push(levelNo);
  updateUI();
  tg.showAlert(`Level \( {levelNo} claimed! + \){reward} coins ðŸš€`);
}

initApp();
setInterval(updateLevelProgressUI, 3000);
</script>
</body>
</html>
