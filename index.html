<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Aether - Earn & Airdrop</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tonconnect/ui@latest/dist/tonconnect-ui.min.css"/>
  <style>
    body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#0f0f1a,#1a1a2e);color:#fff;margin:0;padding:0;overflow-x:hidden}
    .container{max-width:480px;margin:0 auto;padding:15px}
    .header{background:#16213e;border-radius:15px;padding:15px;text-align:center;margin-bottom:20px}
    .logo{font-size:36px;margin-bottom:10px}
    .stats{display:flex;justify-content:space-around;background:#16213e;border-radius:12px;padding:15px;margin-bottom:15px}
    .stat{text-align:center}
    .stat big{font-size:24px;font-weight:bold;display:block}
    .tabs{display:flex;background:#16213e;border-radius:12px;overflow:hidden;margin-bottom:15px}
    .tab{flex:1;padding:12px;text-align:center;cursor:pointer;transition:0.3s}
    .tab.active{background:#00d4ff;color:#000;font-weight:bold}
    .content{background:#16213e;border-radius:12px;padding:20px;min-height:400px}
    .btn{background:#00d4ff;color:#000;border:none;padding:14px;border-radius:12px;width:100%;font-size:16px;font-weight:bold;margin:10px 0;cursor:pointer}
    .btn:disabled{background:#555;cursor:not-allowed}
    .level{margin:15px 0;padding:15px;background:#1e1e2e;border-radius:12px}
    .claim-btn{background:#00ff9d;color:#000}
    .join-btn{background:#7289da;color:#fff;display:flex;align-items:center;justify-content:center;gap:10px;font-size:18px}
    .monthly{font-size:15px;text-align:center;margin:15px 0;color:#00d4ff;font-weight:bold}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">Ae</div>
    <h2>AETHER — Earn & Airdrop</h2>
    <div id="username">@username</div>
  </div>

  <div class="stats">
    <div class="stat"><big id="coins">0</big>Coins</div>
    <div class="stat"><big id="refs">0</big>Referrals</div>
    <div class="stat"><big id="level">1</big>Level</div>
  </div>

  <div class="monthly" id="monthlyUsers">Loading monthly users...</div>

  <div class="tabs">
    <div class="tab active" onclick="show('home')">Home</div>
    <div class="tab" onclick="show('tasks')">Tasks</div>
    <div class="tab" onclick="show('refer')">Referral</div>
    <div class="tab" onclick="show('airdrop')">Airdrop</div>
  </div>

  <div id="home" class="content">
    <button class="btn" id="adBtn">Watch Rewarded Ad (+50)</button>
    <p>Daily ads: <span id="dailyAds">0</span>/20 | Total: <span id="totalAds">0</span></p>
    <div style="margin-top:30px">
      <button class="btn join-btn" onclick="window.open('https://t.me/AetherMineX','_Community','_blank')">
        Join Channel
      </button>
    </div>
  </div>

  <div id="tasks" class="content" style="display:none"><div id="levels"></div></div>
  <div id="refer" class="content" style="display:none">
    <h3>Invite & Earn 1000 Coins</h3>
    <button class="btn" onclick="share()">Share Link</button>
    <p style="margin-top:20px;word-break:break-all" id="refLink">Loading...</p>
  </div>
  <div id="airdrop" class="content" style="display:none">
    <h3>Connect TON Wallet</h3>
    <div id="ton-connect"></div>
    <p id="walletAddress">Not connected</p>
  </div>
</div>

<script>
// LIBTL ADS
function show_10192178(type) {
  return new Promise((resolve, reject) => {
    if (window.LibTL && window.LibTL.show) {
      window.LibTL.show(type, resolve, reject);
    } else {
      reject();
    }
  });
}

// Firebase Config (तेरा असली)
const firebaseConfig = {
  apiKey: "AIzaSyBRMiyuGkjDFfZE9tqgzGVWJalw_6Cypz4",
  authDomain: "earncryptomp.firebaseapp.com",
  databaseURL: "https://earncryptomp-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "earncryptomp",
  storageBucket: "earncryptomp.firebasestorage.app",
  messagingSenderId: "405204250643",
  appId: "1:405204250643:web:8841299bceb46f6752cfe6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const BOT_TOKEN = "8359547898:AAGwkv22tGbWQZQChk8buqQnXXjC9i0ErDg"; // तेरा असली token
const REFERRAL_BONUS = 1000;
const AD_COINS = 50;
const DAILY_LIMIT = 20;

let user = null;
let tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

const connector = new TON_CONNECT.UI.TonConnectUI({
  manifestUrl: 'https://karangangani.github.io/Earncrypto/tonconnect-manifest.json'
});

// INIT
if(tg.initDataUnsafe.user) {
  user = tg.initDataUnsafe.user;
  document.getElementById("username").textContent = "@"+(user.username || user.first_name);
  loadUser();
  loadMonthlyUsers();
  sendAutoReminder();
}

// Load / Create User + Referral Fix
async function loadUser() {
  const refParam = tg.initDataUnsafe.start_param;
  const docRef = db.collection("users").doc(user.id.toString());
  const doc = await docRef.get();

  if (!doc.exists) {
    const newUser = {
      id: user.id,
      username: user.username || user.first_name,
      coins: 0,
      referrals: 0,
      level: 1,
      dailyAds: 0,
      totalAds: 0,
      lastAdDate: new Date().toDateString(),
      joinedAt: new Date(),
      lastActive: new Date()
    };
    if (refParam && refParam.startsWith("ref_")) {
      const refId = refParam.split("_")[1];
      if (refId != user.id) newUser.referrer = refId;
    }
    await docRef.set(newUser);
    if (refParam && refParam.startsWith("ref_")) await giveReferralBonus(refParam.split("_")[1]);
  } else {
    await docRef.update({ lastActive: new Date() });
    if (refParam && refParam.startsWith("ref_") && !doc.data().referrer) {
      await giveReferralBonus(refParam.split("_")[1]);
    }
  }

  const data = (await docRef.get()).data();
  updateUI(data);
  showLevels(data);
  document.getElementById("refLink").textContent = `https://t.me/AetherMineXBot?startapp=ref_${user.id}`;
}

// Referral Bonus (Admin panel में भी दिखेगा)
async function giveReferralBonus(refId) {
  if (!refId || refId == user.id) return;
  const refDoc = db.collection("users").doc(refId);
  await db.runTransaction(async t => {
    const d = await t.get(refDoc);
    if (d.exists) {
      t.update(refDoc, {
        referrals: firebase.firestore.FieldValue.increment(1),
        coins: firebase.firestore.FieldValue.increment(REFERRAL_BONUS)
      });
    }
  });
}

// Watch Ad
document.getElementById("adBtn").onclick = async () => {
  const docRef = db.collection("users").doc(user.id.toString());
  const snap = await docRef.get();
  const data = snap.data();
  const today = new Date().toDateString();

  if (data.lastAdDate !== today && data.dailyAds > 0) {
    await docRef.update({ dailyAds: 0, lastAdDate: today });
  }
  if (data.dailyAds >= DAILY_LIMIT) return alert("Daily limit reached!");

  show_10192178('pop').then(async () => {
    await docRef.update({
      coins: firebase.firestore.FieldValue.increment(AD_COINS),
      dailyAds: firebase.firestore.FieldValue.increment(1),
      totalAds: firebase.firestore.FieldValue.increment(1)
    });
    loadUser();
  }).catch(() => {});
};

// Share
function share() {
  const link = `https://t.me/AetherMineXBot?startapp=ref_${user.id}`;
  navigator.clipboard.writeText(link);
  tg.showPopup({message: "Referral link copied!" });
}

// UI Update
function updateUI(d) {
  document.getElementById("coins").textContent = d.coins || 0;
  document.getElementById("refs").textContent = d.referrals || 0;
  document.getElementById("level").textContent = d.level || 1;
  document.getElementById("dailyAds").textContent = d.dailyAds || 0;
  document.getElementById("totalAds").textContent = d.totalAds || 0;
}
  // Levels System (same as before)
async function showLevels(d) {
  let html = "";
  for (let i=1; i<=10; i++) {
    const rRefs = i, rAds = i*15, rew = i*500;
    const ok = (d.referrals||0)>=rRefs && (d.totalAds||0)>=rAds;
    const claimed = d[`level${i}Claimed`];
    html += `<div class="level"><strong>Level \( {i}</strong><br>Need \){rRefs} refs & \( {rAds} ads → \){rew} coins
      <button class="btn claim-btn" \( {ok && !claimed?'':'disabled'} onclick="claim( \){i},${rew})">
        ${ok && !claimed?'Claim':ok?'Claimed':'Locked'}</button></div>`;
  }
  document.getElementById("levels").innerHTML = html;
}
async function claim(l,r) {
  await db.collection("users").doc(user.id.toString()).update({
    coins: firebase.firestore.FieldValue.increment(r),
    level: firebase.firestore.FieldValue.increment(1),
    [`level${l}Claimed`]: true
  });
  loadUser();
}

// Monthly Active Users
async function loadMonthlyUsers() {
  const monthAgo = new Date(); monthAgo.setMonth(monthAgo.getMonth()-1);
  const snap = await db.collection("users").where("lastActive", ">=", monthAgo).get();
  document.getElementById("monthlyUsers").textContent = `${snap.size.toLocaleString()} monthly users`;
}

// 8-Hour Auto Reminder
async function sendAutoReminder() {
  const key = "lastReminder";
  const last = localStorage.getItem(key);
  const now = Date.now();
  if (!last || now - parseInt(last) > 8*60*60*1000) {
    const msgs = [
      "Hey! Don't forget your daily tasks — 1000+ coins waiting!",
      "Aether airdrop coming soon — keep mining!",
      "Daily login bonus active — watch ads now!",
      "New level unlocked? Check Tasks tab!"
    ];
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({chat_id:user.id, text:msgs[Math.floor(Math.random()*msgs.length)]})
    });
    localStorage.setItem(key, now);
  }
}

// Tab Switch
function show(t){ document.querySelectorAll(".content").forEach(c=>c.style.display="none");
  document.getElementById(t).style.display="block";
  document.querySelectorAll(".tab").forEach(tab=>tab.classList.remove("active"));
  event.target.classList.add("active");
}

// TON Connect
document.getElementById("ton-connect").innerHTML = '<ton-connect-button></ton-connect-button>';
connector.onStatusChange(w=> {
  document.getElementById("walletAddress").textContent = w ? w.account.address.slice(0,6)+"..."+w.account.address.slice(-4) : "Not connected";
});
</script>
</body>
</html>
