<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AETHER ‚Äî Premium Earn & Airdrop</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css"/>

<script src='//libtl.com/sdk.js' data-zone='10192178' data-sdk='show_10192178'></script>

<style>
:root {
  --bg: #0a0a0a;
  --card: #111113;
  --accent: #00ff9d;
  --text: #e0e0e0;
  --muted: #888;
  --border: rgba(0,255,157,0.15);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: linear-gradient(135deg, #000000, #051028);
  color: var(--text);
  min-height: 100vh;
  padding: 16px;
  overflow-x: hidden;
}
body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: radial-gradient(circle at 30% 70%, rgba(0,255,157,0.12) 0%, transparent 50%);
  z-index: -1;
  animation: breathe 12s ease-in-out infinite;
}
@keyframes breathe { 0%,100% { opacity: 0.6; } 50% { opacity: 1; } }
.wrap { max-width: 720px; margin: 0 auto; }
.header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  border-radius: 20px;
  background: linear-gradient(135deg, rgba(0,255,157,0.1), rgba(0,0,0,0.4));
  border: 1px solid var(--border);
  box-shadow: 0 8px 32px rgba(0,255,157,0.1);
}
.logo {
  width: 72px; height: 72px;
  border-radius: 18px;
  background: linear-gradient(135deg, #00ff9d, #00b36b);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  font-weight: 900;
  color: #000;
  box-shadow: 0 0 30px rgba(0,255,157,0.4);
  animation: logoPulse 3s ease-in-out infinite;
}
@keyframes logoPulse { 0%,100% { box-shadow: 0 0 30px rgba(0,255,157,0.4); } 50% { box-shadow: 0 0 50px rgba(0,255,157,0.6); } }
h1 { font-size: 22px; font-weight: 800; color: var(--accent); }
.sub { font-size: 14px; color: var(--muted); margin-top: 4px; }
.card {
  background: var(--card);
  border-radius: 20px;
  margin-top: 16px;
  border: 1px solid var(--border);
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}
.stats {
  display: flex;
  gap: 12px;
  padding: 20px;
}
.stat {
  flex: 1;
  background: rgba(0,255,157,0.08);
  border-radius: 16px;
  padding: 16px;
  text-align: center;
  border: 1px solid rgba(0,255,157,0.2);
}
.v { font-size: 28px; font-weight: 800; color: var(--accent); }
.l { font-size: 13px; color: var(--muted); margin-top: 4px; }
.tabs {
  display: flex;
  background: rgba(0,0,0,0.3);
  border-top: 1px solid var(--border);
}
.tab {
  flex: 1;
  padding: 16px;
  text-align: center;
  font-weight: 600;
  color: var(--muted);
  cursor: pointer;
  transition: 0.3s;
}
.tab.active {
  color: var(--accent);
  background: rgba(0,255,157,0.15);
  border-bottom: 3px solid var(--accent);
}
.section { padding: 20px; display: none; }
.section.active { display: block; animation: fadeIn 0.4s; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.btn {
  width: 100%;
  padding: 18px;
  border-radius: 16px;
  border: none;
  background: linear-gradient(90deg, #00ff9d, #00b36b);
  color: #000;
  font-weight: 800;
  font-size: 16px;
  cursor: pointer;
  margin-top: 12px;
  box-shadow: 0 8px 20px rgba(0,255,157,0.3);
  transition: 0.3s;
}
.btn:hover { transform: translateY(-2px); box-shadow: 0 12px 30px rgba(0,255,157,0.4); }
.small { font-size: 14px; color: var(--muted); margin-top: 8px; text-align: center; line-height: 1.5; }
.highlight-channel {
  background: linear-gradient(135deg, rgba(0,255,157,0.2), rgba(0,176,107,0.2));
  border: 2px solid var(--accent);
  border-radius: 18px;
  padding: 20px;
  margin: 20px 0;
  text-align: center;
  box-shadow: 0 8px 25px rgba(0,255,157,0.2);
}
.highlight-channel h3 {
  color: var(--accent);
  font-size: 18px;
  margin-bottom: 10px;
  font-weight: 800;
}
.levels { margin-top: 16px; }
.level {
  background: rgba(0,255,157,0.08);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid rgba(0,255,157,0.2);
  transition: 0.3s;
}
.level:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,255,157,0.15); }
.claimBtn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(90deg, #00ff9d, #00b36b);
  color: #000;
  border: none;
  border-radius: 14px;
  font-weight: 800;
  margin-top: 12px;
  cursor: pointer;
}
.footer {
  text-align: center;
  margin-top: 30px;
  color: var(--muted);
  font-size: 13px;
}
</style>
</head>
<body>

<div class="wrap">
  <div class="header">
    <div class="logo">Ae </div>
    <div>
      <h1>AETHER</h1>
      <div class="sub" id="userLine">Loading...</div>
    </div>
  </div>

  <div class="card">
    <div class="stats">
      <div class="stat"><div class="v" id="points">0</div><div class="l">Coins</div></div>
      <div class="stat"><div class="v" id="refs">0</div><div class="l">Referrals</div></div>
      <div class="stat"><div class="v" id="level">1</div><div class="l">Level</div></div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="openTab('home')">Home</div>
      <div class="tab" onclick="openTab('tasks')">Earn</div>
      <div class="tab" onclick="openTab('referral')">Invite</div>
      <div class="tab" onclick="openTab('airdrop')">Airdrop</div>
    </div>

    <!-- HOME -->
    <div id="home" class="section active">
      <button id="startMining" class="btn">Start Passive Earning</button>
      <p class="small">+1 coin every 2 seconds ‚Ä¢ Daily streak bonus</p>

      <div class="highlight-channel">
        <h3>‚≠ê Official Channel</h3>
        <p>Join for exclusive updates, alpha calls, giveaways & airdrop news!</p>
        <button id="openChannel" class="btn">Join @AetherMineX Now</button>
      </div>

      <button id="enableNotifications" class="btn">Enable Notifications & Get +200 Coins Bonus</button>
      <p class="small">Get instant alerts for bonuses, updates & airdrop</p>
    </div>

    <!-- EARN -->
    <div id="tasks" class="section">
      <button id="watchAd" class="btn">Watch Ad (+50 Coins)</button>
      <p class="small">Daily: <span id="adsToday">0</span> / <span id="adsLimit">20</span> ‚Ä¢ Total: <span id="totalAds">0</span></p>

      <div class="small" style="margin-top:20px;font-weight:600">Level Progress & Rewards</div>
      <div id="levelsList" class="levels"></div>
      <div style="text-align:center;margin-top:16px">
        <button id="showAllLevels" class="btn" style="background:#333;color:#fff;box-shadow:none">Load More Levels</button>
      </div>
    </div>

    <!-- INVITE -->
    <div id="referral" class="section">
      <div style="text-align:center;padding:20px">
        <h3 style="color:var(--accent);font-size:20px;margin-bottom:12px">Invite Friends & Earn More</h3>
        <p style="margin-bottom:20px">Each successful referral = <strong>+500 coins for both</strong></p>
        <div style="background:rgba(0,255,157,0.1);padding:20px;border-radius:16px;border:1px solid var(--border)">
          <div id="myRef" style="color:var(--accent);font-size:15px;word-break:break-all">Generating...</div>
          <button id="copyRef" class="btn" style="margin-top:16px">COPY LINK</button>
        </div>
      </div>
    </div>

    <!-- AIRDROP -->
    <div id="airdrop" class="section">
      <div style="text-align:center;padding:20px">
        <h3 style="color:var(--accent);font-size:22px;margin-bottom:16px">TON Airdrop Coming Soon</h3>
        <p style="margin-bottom:20px;line-height:1.6">Stay active, invite friends, connect wallet<br>Higher activity = bigger share</p>
        <div style="display:flex;gap:12px;align-items:center;justify-content:center">
          <button id="connectTon" class="btn">Connect TON Wallet</button>
          <div id="tonBtnRoot" style="width:120px"></div>
        </div>
        <p class="small" id="walletStatus" style="margin-top:16px">Not Connected</p>
        <button id="showBalance" class="btn" style="margin-top:16px;background:#333;color:#fff">Show Address</button>
      </div>
    </div>
  </div>
   <div class="footer">
    ¬© AETHER ‚Ä¢ Premium TON Project ‚Ä¢ Bot: @AetherMineXBot
  </div>
</div>

<script>
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBRMiyuGkjDFfZE9tqgzGVWJalw_6Cypz4",
  authDomain: "earncryptomp.firebaseapp.com",
  projectId: "earncryptomp",
  storageBucket: "earncryptomp.firebasestorage.app",
  messagingSenderId: "405204250643",
  appId: "1:405204250643:web:8841299bceb46f6752cfe6"
};
const AD_FN = 'show_10192178';
const DAILY_BASE = 20;
const ADS_COOLDOWN_MS = 5000;
const LEVELS_MAX = 100;
const LEVEL_RENDER_CHUNK = 20;
const TON_MANIFEST = 'https://karangangani.github.io/Earncrypto/tonconnect-manifest.json';

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
const auth = firebase.auth();

const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const tgUser = tg.initDataUnsafe.user || {};
let userDocId = null;
let current = {
  coins: 0, refs: [], level: 1, adsToday: 0, totalAds: 0, claimedLevels: [], tonWallet: '', notificationsEnabled: false, refCode: ''
};
let tonUI = null;
let adLastTime = 0;
let levelsRendered = 0;
let unsubscribeSnapshot = null;

const startParam = tg.initDataUnsafe.start_param || tg.initDataUnsafe.startapp || '';

function userRef() { return db.collection('users').doc(userDocId); }

async function initApp() {
  try {
    await auth.signInAnonymously();

    const tgId = tgUser.id ? tgUser.id.toString() : ('guest_' + Date.now()).toString();
    userDocId = tgId;

    let doc = await userRef().get();
    let isNewUser = !doc.exists;
    let displayName = tgUser.username ? '@' + tgUser.username : (tgUser.first_name || 'Guest');
    current.username = displayName;

    if (isNewUser) {
      current.refCode = 'ref_' + Math.floor(Math.random() * 9000000 + 1000000);
      await userRef().set({
        coins: 20, refs: [], level: 1, adsToday: 0, totalAds: 0, claimedLevels: [], tonWallet: '', notificationsEnabled: false, refCode: current.refCode, telegramId: tgId
      });
    } else {
      const data = doc.data();
      Object.assign(current, data);
    }

    document.getElementById('userLine').innerText = current.username + ' ‚Ä¢ ' + current.refCode.split('_')[1];

    if (unsubscribeSnapshot) unsubscribeSnapshot();
    unsubscribeSnapshot = userRef().onSnapshot(docSnap => {
      if (docSnap.exists) {
        Object.assign(current, docSnap.data());
        updateUI();
        updateLevelProgressUI();
        updateNotificationButton();
      }
    });

    // Referral link with ?start= for bot
    const refLink = 'https://t.me/AetherMineXBot?start=' + current.refCode;
    document.getElementById('myRef').innerText = refLink;
    document.getElementById('copyRef').onclick = () => navigator.clipboard.writeText(refLink).then(() => tg.showAlert('Copied!'));

    // Auto open bot chat
    setTimeout(() => tg.openTelegramLink('https://t.me/AetherMineXBot'), 1500);

    tonUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: TON_MANIFEST, buttonRootId: 'tonBtnRoot' });

    document.getElementById('connectTon').onclick = () => tonUI.connectWallet();
    document.getElementById('watchAd').onclick = watchAdHandler;
    document.getElementById('openChannel').onclick = () => tg.openTelegramLink('https://t.me/AetherMineX');
    document.getElementById('startMining').onclick = startPassiveMining;
    document.getElementById('showAllLevels').onclick = () => renderLevelsChunk(50);
    document.getElementById('showBalance').onclick = () => tg.showAlert(current.tonWallet || 'Not connected');
    document.getElementById('enableNotifications').onclick = enableNotificationsHandler;

    if (startParam && startParam.startsWith('ref_')) {
      await handleReferralParam(startParam);
    }

    renderLevelsChunk(LEVEL_RENDER_CHUNK);
    await checkDailyLogin();
    updateUI();
    updateNotificationButton();

  } catch (error) {
    console.error(error);
    tg.showAlert('Error. Retry.');
  }
}

async function enableNotificationsHandler() {
  try {
    const granted = await tg.requestWriteAccess();
    if (granted) {
      await userRef().update({ notificationsEnabled: true, coins: firebase.firestore.FieldValue.increment(200) });
      current.coins += 200;
      current.notificationsEnabled = true;
      updateUI();
      updateNotificationButton();
      tg.showAlert('‚úÖ Notifications enabled!\n+200 coins bonus!\n\nWarning: Do not delete bot chat!');
    }
  } catch (e) {
    tg.showAlert('Failed. Try again.');
  }
}

function updateNotificationButton() {
  const btn = document.getElementById('enableNotifications');
  if (current.notificationsEnabled) {
    btn.innerText = 'Notifications Enabled ‚úì (+200 coins)';
    btn.disabled = true;
  } else {
    btn.innerText = 'Enable Notifications & Get +200 Coins Bonus';
    btn.disabled = false;
  }
}

async function handleReferralParam(param) {
  const referrerId = param.replace('ref_', '');
  if (!referrerId || referrerId === userDocId) return;

  const userSnap = await userRef().get();
  if (userSnap.data().refs?.includes(referrerId)) return;

  const referrerDoc = await db.collection('users').doc(referrerId).get();
  if (!referrerDoc.exists) return;

  await userRef().update({ refs: firebase.firestore.FieldValue.arrayUnion(referrerId) });
  await db.collection('users').doc(referrerId).update({ refs: firebase.firestore.FieldValue.arrayUnion(userDocId) });
  await userRef().update({ coins: firebase.firestore.FieldValue.increment(500) });
  await db.collection('users').doc(referrerId).update({ coins: firebase.firestore.FieldValue.increment(500) });

  current.refs.push(referrerId);
  current.coins += 500;
  updateUI();
  tg.showAlert('Referral success! +500 coins each üéâ');
}

async function checkDailyLogin() {
  const today = new Date().toDateString();
  if (current.lastLogin === today) return;
  const streak = (current.streak || 0) % 7 + 1;
  const bonus = [100,200,300,400,500,700,1000][streak - 1] || 100;
  await userRef().update({ coins: firebase.firestore.FieldValue.increment(bonus), streak, lastLogin: today });
  current.coins += bonus;
  updateUI();
  tg.showAlert('Daily bonus: +' + bonus + ' coins!');
}

function updateUI() {
  document.getElementById('points').innerText = Math.floor(current.coins || 0);
  document.getElementById('refs').innerText = current.refs?.length || 0;
  document.getElementById('level').innerText = current.level || 1;
  document.getElementById('adsToday').innerText = current.adsToday || 0;
  document.getElementById('totalAds').innerText = current.totalAds || 0;
  const dailyLimit = DAILY_BASE + Math.max(0, (current.level || 1) - 1) * 20;
  document.getElementById('adsLimit').innerText = dailyLimit;
  document.getElementById('walletStatus').innerText = current.tonWallet ? `Connected: \( {current.tonWallet.slice(0,6)}... \){current.tonWallet.slice(-4)}` : 'Not Connected';
}

function openTab(tab) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
}

let mining = false;
function startPassiveMining() {
  if (mining) return tg.showAlert('Already mining!');
  mining = true;
  document.getElementById('startMining').innerText = 'Mining Active...';
  setInterval(async () => {
    if (!mining) return;
    await userRef().update({ coins: firebase.firestore.FieldValue.increment(1) });
    current.coins += 1;
    updateUI();
  }, 2000);
  tg.showAlert('Passive mining started!');
}
  async function watchAdHandler() {
  const now = Date.now();
  const dailyLimit = DAILY_BASE + Math.max(0, (current.level || 1) - 1) * 20;
  if (current.adsToday >= dailyLimit) return tg.showAlert('Daily limit reached');
  if (now - adLastTime < ADS_COOLDOWN_MS) return tg.showAlert('Wait 5s');
  adLastTime = now;

  const btn = document.getElementById('watchAd');
  btn.disabled = true;
  btn.innerText = 'Loading...';

  try {
    if (typeof window[AD_FN] === 'function') await window[AD_FN]('pop');
    else await new Promise(r => setTimeout(r, 1500));

    await userRef().update({
      coins: firebase.firestore.FieldValue.increment(50),
      adsToday: firebase.firestore.FieldValue.increment(1),
      totalAds: firebase.firestore.FieldValue.increment(1)
    });
    current.coins += 50;
    current.adsToday += 1;
    current.totalAds += 1;
    updateUI();
    tg.showAlert('+50 coins!');
  } catch (e) {
    tg.showAlert('Ad not completed');
  }
  btn.disabled = false;
  btn.innerText = 'Watch Ad (+50 Coins)';
}

async function trySaveTonWallet(addr) {
  await userRef().update({ tonWallet: addr });
  current.tonWallet = addr;
  updateUI();
  tg.showAlert('Wallet connected!');
}

function renderLevelsChunk(max) {
  const container = document.getElementById('levelsList');
  const start = levelsRendered + 1;
  const end = Math.min(LEVELS_MAX, levelsRendered + max);
  for (let i = start; i <= end; i++) {
    const refsNeeded = i;
    const adsNeeded = i;
    const reward = 500 * i;
    const el = document.createElement('div');
    el.className = 'level';
    el.innerHTML = `
      <div style="font-weight:800;color:var(--accent)">Level ${i}</div>
      <div class="small">Requires: \( {refsNeeded} referral \){refsNeeded > 1 ? 's' : ''} & \( {adsNeeded} ad \){adsNeeded > 1 ? 's' : ''}</div>
      <div class="small">Reward: ${reward} coins</div>
      <div style="margin-top:10px"><button id="claim_${i}" class="claimBtn" disabled>Claim</button></div>
    `;
    container.appendChild(el);
    document.getElementById(`claim_${i}`).onclick = () => claimLevel(i, refsNeeded, adsNeeded, reward);
  }
  levelsRendered = end;
  updateLevelProgressUI();
}

async function updateLevelProgressUI() {
  const refsCount = current.refs?.length || 0;
  const adsDone = current.totalAds || 0;
  for (let i = 1; i <= levelsRendered; i++) {
    const btn = document.getElementById(`claim_${i}`);
    if (!btn) continue;
    const refsNeeded = i;
    const adsNeeded = i;
    const claimed = current.claimedLevels?.includes(i);
    btn.disabled = claimed || !(refsCount >= refsNeeded && adsDone >= adsNeeded);
    btn.innerText = claimed ? 'Claimed' : 'Claim';
  }
}

async function claimLevel(levelNo, refsNeeded, adsNeeded, reward) {
  const refsCount = current.refs?.length || 0;
  const adsDone = current.totalAds || 0;
  if (refsCount < refsNeeded || adsDone < adsNeeded) return tg.showAlert('Requirements not met');
  if (current.claimedLevels?.includes(levelNo)) return tg.showAlert('Already claimed');
  await userRef().update({
    coins: firebase.firestore.FieldValue.increment(reward),
    claimedLevels: firebase.firestore.FieldValue.arrayUnion(levelNo)
  });
  current.coins += reward;
  current.claimedLevels.push(levelNo);
  updateUI();
  tg.showAlert(`Level \( {levelNo} claimed! + \){reward} coins!`);
}

initApp();
setInterval(updateLevelProgressUI, 3000);
</script>
</body>
</html>
