<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AetherMine</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- LATEST TONCONNECT UI -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css"/>

  <!-- ADS -->
  <script src='//libtl.com/sdk.js' data-zone='10192178' data-sdk='show_10192178'></script>

  <style>
    body { background:#000; color:#fff; font-family:Arial; text-align:center; padding:15px; }
    .logo { font-size:50px; font-weight:900; color:#00ff88; margin:30px 0; }
    .card { background:#111; padding:20px; border-radius:20px; margin:15px 0; }
    .btn { background:#00ff88; color:#000; padding:18px; border:none; border-radius:16px; font-size:18px; font-weight:bold; margin:10px 0; width:100%; }
    .big { font-size:32px; color:#00ff88; }
    .wallet { margin:20px 0; font-size:15px; word-break:break-all; }
  </style>
</head>
<body>

  <div class="logo">Aether</div>
  <div id="username" style="margin-bottom:20px;">Loading...</div>

  <div class="card">
    <div class="big" id="points">0</div>
    <small>Points</small>
    <div style="margin:15px 0;" class="big" id="refs">0</div>
    <small>Referrals</small>
  </div>

  <!-- TON CONNECT BUTTON -->
  <div id="ton-connect"></div>

  <div class="wallet" id="wallet">Not Connected</div>

  <div class="card">
    <button class="btn" id="ad">Watch Ad (+50 Points)</button>
    <p>Daily: <span id="adsToday">0</span>/100</p>
  </div>

  <div class="card">
    <p>Your Referral Link:</p>
    <div style="background:#222;padding:15px;border-radius:12px;margin:10px 0;word-break:break-all;" id="refLink">Loading...</div>
  </div>

  <script>
    // REPLACE YE URL APNE GITHUB WALE SE
    const MANIFEST_URL = "https://raw.githubusercontent.com/YOUR_GITHUB_USERNAME/aethermine-ton/main/tonconnect-manifest.json";

    firebase.initializeApp({
      apiKey: "AIzaSyBRMiyuGkjDFfZE9tqgzGVWJalw_6Cypz4",
      authDomain: "earncryptomp.firebaseapp.com",
      projectId: "earncryptomp",
      appId: "1:405204250643:web:8841299bceb46f6752cfe6"
    });
    const db = firebase.firestore();

    const tg = window.Telegram.WebApp;
    tg.ready();
    const user = tg.initDataUnsafe.user || { id: 123456, first_name: "Test" };
    const userId = user.id.toString();

    // TON CONNECT UI
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: MANIFEST_URL,
      buttonRootId: 'ton-connect'
    });

    let points = 0, adsToday = 0;

    // Wallet status
    tonConnectUI.onStatusChange(async (w) => {
      if (w) {
        const addr = w.account.address;
        document.getElementById('wallet').innerHTML = `<b>Connected:</b><br>\( {addr.slice(0,8)}... \){addr.slice(-6)}`;
        await db.collection('users').doc(userId).set({ tonWallet: addr }, { merge: true });
      }
    });

    async function init() {
      document.getElementById('username').innerText = user.username || user.first_name;

      const doc = await db.collection('users').doc(userId).get();
      if (!doc.exists) {
        await db.collection('users').doc(userId).set({ points: 0, adsToday: 0 });
      } else {
        const d = doc.data();
        points = d.points || 0;
        adsToday = d.adsToday || 0;
        if (d.tonWallet) document.getElementById('wallet').innerHTML = `<b>Connected:</b><br>\( {d.tonWallet.slice(0,8)}... \){d.tonWallet.slice(-6)}`;
      }

      document.getElementById('points').innerText = points;
      document.getElementById('adsToday').innerText = adsToday;
      document.getElementById('refLink').innerText = `https://t.me/AetherMineXBot?start=ref_${userId}`;

      // Referral handle
      const params = new URLSearchParams(location.search);
      const ref = params.get('startapp') || params.get('start');
      if (ref?.startsWith('ref_')) {
        const refId = ref.split('_')[1];
        if (refId !== userId) {
          await db.collection('users').doc(refId).update({
            points: firebase.firestore.FieldValue.increment(500)
          });
          tg.showAlert("Referral +500 Points!");
        }
      }
    }

    // Watch Ad
    document.getElementById('ad').onclick = () => {
      if (adsToday >= 100) return tg.showAlert("Limit reached");
      document.getElementById('ad').disabled = true;
      show_10192178('pop').then(async () => {
        points += 50; adsToday += 1;
        await db.collection('users').doc(userId).update({ points, adsToday });
        document.getElementById('points').innerText = points;
        document.getElementById('adsToday').innerText = adsToday;
        tg.showAlert("+50 Points!");
        document.getElementById('ad').disabled = false;
      }).catch(() => {
        document.getElementById('ad').disabled = false;
      });
    };

    init();
  </script>
</body>
</html>
