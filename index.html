<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AETHER â€” Earn & Airdrop (Stable v5 â€” website + whitepaper + channel flow)</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- TON connect UI -->
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css"/>

<!-- Ad SDK (kept) -->
<script src='//libtl.com/sdk.js' data-zone='10192178' data-sdk='show_10192178'></script>

<style>
:root{ --bg:linear-gradient(135deg,#0c0c0c,#1a1a2e); --card:#0f0f23; --accent:#00d38a; --text:#fff; --muted:#a0a8b0; --border:rgba(0,211,138,0.3); --glow:0 0 20px rgba(0,211,138,0.5); }
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:var(--muted);min-height:100vh;padding:14px;overflow-x:hidden}
.wrap{max-width:720px;margin:12px auto}
.header{display:flex;gap:12px;align-items:center;padding:14px;border-radius:16px;background:linear-gradient(135deg, rgba(0,211,138,0.06), rgba(0,211,138,0.02));border:1px solid var(--border);box-shadow:var(--glow)}
.logo{width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,#1a1a2e,#16213e);display:flex;align-items:center;justify-content:center;color:var(--text);font-weight:900;box-shadow:var(--glow)}
.logo::after{content:'Ae';font-size:24px;font-weight:900;color:var(--accent)}
.user-dp{width:32px;height:32px;border-radius:50%;margin-left:8px;border:2px solid var(--accent)}
h1{color:var(--text);font-size:20px;margin-bottom:2px;font-weight:700}
.sub{color:var(--muted);font-size:13px}
.card{background:var(--card);padding:18px;border-radius:16px;margin-top:12px;border:1px solid rgba(255,255,255,0.05);box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.stats{display:flex;gap:10px}
.stat{flex:1;padding:14px;background:rgba(0,211,138,0.06);border-radius:12px;text-align:center}
.v{font-weight:900;color:var(--text);font-size:20px}
.l{font-size:11px;color:var(--muted)}
.tabs{display:flex;gap:8px;margin-top:12px}
.tab{flex:1;padding:12px;border-radius:12px;text-align:center;background:transparent;border:1px solid rgba(255,255,255,0.05);cursor:pointer;color:var(--muted);font-weight:600}
.tab.active{background:rgba(0,211,138,0.2);color:var(--text);border-color:var(--accent);box-shadow:var(--glow)}
.section{display:none;padding-top:12px}
.section.active{display:block}
.btn{width:100%;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent),#00a877);color:#001;font-weight:800;cursor:pointer;margin-top:8px;box-shadow:0 4px 10px rgba(0,211,138,0.3)}
.btn.secondary{background:linear-gradient(135deg,#333,#555);color:#fff}
.btn:disabled{opacity:.6;cursor:not-allowed}
.small{font-size:13px;color:var(--muted);margin-top:8px;text-align:center}
.ref-box{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:12px;background:rgba(0,211,138,0.04);border:1px solid var(--border)}
.levels{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px}
.level{padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid var(--border)}
.claimBtn{background:linear-gradient(135deg,var(--accent),#00a877);color:#001;padding:10px;border-radius:8px;border:none;cursor:pointer;font-weight:700;width:100%;margin-top:10px}
.claimBtn:disabled{background:#333;color:#666;cursor:not-allowed}
.leader-item{padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between}
.ref-item{padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:8px}
.footer{margin-top:20px;text-align:center;color:var(--muted);font-size:12px;padding:10px;background:rgba(0,0,0,0.2);border-radius:12px}
.modal-bg{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal{background:linear-gradient(135deg,#071026,#0f1724);padding:22px;border-radius:12px;color:#fff;max-width:720px;width:92%;box-shadow:var(--glow);border:1px solid var(--border)}
.modal h2{color:var(--accent);margin-bottom:8px}
.modal p{color:var(--muted);line-height:1.45}
.modal .small-note{color:#cbd5e1;margin-top:12px}
#welcomeChannel{position:fixed;right:14px;bottom:14px;background:linear-gradient(135deg,#00d38a,#009772);color:#001;padding:12px;border-radius:12px;box-shadow:var(--glow);display:none;z-index:10000}
#tonBtnRoot{display:inline-block}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="logo"></div>
    <img id="user-dp" class="user-dp" src="" alt="User DP" style="display:none">
    <div style="flex:1">
      <h1>AETHER â€” Earn & Airdrop</h1>
      <div id="userLine" class="sub">Loading...</div>
    </div>
  </div>

  <div class="card">
    <div class="stats">
      <div class="stat"><div class="v" id="points">0</div><div class="l">Ae</div></div>
      <div class="stat"><div class="v" id="refs">0</div><div class="l">Referrals</div></div>
      <div class="stat"><div class="v" id="level">0</div><div class="l">Level</div></div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="openTab('home', event)">Home</div>
      <div class="tab" onclick="openTab('tasks', event)">Earn</div>
      <div class="tab" onclick="openTab('referral', event)">Invite</div>
      <div class="tab" onclick="openTab('airdrop', event)">Airdrop</div>
    </div>

    <!-- HOME -->
    <div id="home" class="section active">
      <div style="text-align:center">
        <button id="openWebsite" class="btn">Official Website â€” Read More</button>
        <div style="height:10px"></div>
        <button id="openChannelBtn" class="btn secondary">Join Official Channel</button>
        <p class="small" style="margin-top:10px">Stay updated â€” airdrop & roadmap info inside website.</p>
      </div>
    </div>

    <!-- EARN -->
    <div id="tasks" class="section">
      <button id="watchAd" class="btn">Watch Ad (+<span id="adReward">100</span> Ae)</button>
      <p class="small">Level: <span id="levelDisplay">0</span> â€¢ Ads Watched Today: <span id="totalAds">0</span></p>
      <div id="warn"></div>
      <div class="small" style="margin-top:20px;font-weight:600;color:var(--accent)">Level Rewards</div>
      <div id="levelsList" class="levels"></div>
      <div style="text-align:center;margin-top:16px">
        <button id="showAllLevels" class="btn secondary">Load More Levels</button>
      </div>
    </div>

    <!-- INVITE -->
    <div id="referral" class="section">
      <div style="text-align:center;padding:20px">
        <h3 style="color:var(--accent);font-size:20px">Invite Friends & Earn</h3>
        <p>Each referral = +5000 Ae for both!</p>
        <div class="ref-box">
          <div id="myRef">Generating...</div>
          <button id="copyRef" class="btn">COPY LINK</button>
        </div>
        <h3 style="color:var(--accent);margin-top:20px">Your Referrals</h3>
        <ul id="refList"></ul>
        <h3 style="color:var(--accent);margin-top:20px">Leaderboard</h3>
        <div id="leaderList"></div>
      </div>
    </div>

    <!-- AIRDROP -->
    <div id="airdrop" class="section">
      <div id="airdrop-locked" style="display:none;text-align:center;padding:20px;color:#ff5555">
        <h3>Airdrop Locked</h3><p>Invite 3 friends to unlock!</p>
      </div>
      <div id="airdrop-content" style="display:none;text-align:center;padding:20px">
        <h3 style="color:var(--accent);font-size:22px">Airdrop Ready</h3>
        <p>Connect TON wallet to claim.</p>
        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:12px">
          <button id="connectTon" class="btn">Connect TON Wallet</button>
          <button id="disconnectTon" class="btn secondary" style="display:none">Disconnect Wallet</button>
          <div id="tonBtnRoot"></div>
        </div>
        <p class="small" id="walletStatus" style="margin-top:16px">Not Connected</p>
      </div>
    </div>

  </div>

  <div class="footer">Â© AETHER â€¢ 2025 â€¢ Contact: karangangani05@gmail.com</div>
</div>

<!-- Website modal -->
<div id="websiteModal" class="modal-bg" style="display:none">
  <div class="modal" role="dialog" aria-modal="true">
    <h2>Welcome to AETHER â€” Phase 1</h2>
    <p><strong>Total supply:</strong> 97,000,000,000 Ae</p>
    <p><strong>Airdrop allocation:</strong> 30% of total supply will be distributed to early users and community.</p>
    <p>We use ad revenue to add liquidity and fund long-term development. This is <em>Phase 1</em> â€” we're preparing infrastructure and planning future blockchain systems (Infinity Blockchain). Early users receive priority benefits and extra airdrop boosts.</p>
    <p class="small-note"><strong>Contact:</strong> karangangani05@gmail.com â€¢ <strong>Disclaimer:</strong> AETHER is an early-stage project. Do not share private keys. This is not financial advice; tokens/airdrops depend on project conditions.</p>

    <div style="display:flex;gap:10px;margin-top:14px">
      <a id="whitepaperHref" href="https://karangangani.github.io/Earncrypto/whitepaper.pdf" target="_blank" class="btn" rel="noopener noreferrer">Download Whitepaper / One-pager</a>
      <button id="visitAppCTA" class="btn secondary">Back to App</button>
    </div>

    <div style="margin-top:10px">
      <button id="joinChannelModalBtn" class="btn secondary">Join Official Channel</button>
    </div>
  </div>
</div>

<!-- Channel welcome small toast (after user taps join) -->
<div id="welcomeChannel" role="status" aria-live="polite">
  <div style="font-weight:800;margin-bottom:6px">Welcome to AETHER Channel ðŸ‘‹</div>
  <div style="font-size:13px;color:#013122">Thanks for joining â€” check pinned post for airdrop steps. Stay safe: never share keys. Tap to close.</div>
</div>

<script>
/* ========= CONFIG & CONSTANTS ========= */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBRMiyuGkjDFfZE9tqgzGVWJalw_6Cypz4",
  authDomain: "earncryptomp.firebaseapp.com",
  projectId: "earncryptomp",
  storageBucket: "earncryptomp.firebasestorage.app",
  messagingSenderId: "405204250643",
  appId: "1:405204250643:web:8841299bceb46f6752cfe6"
};

const STORAGE_STATE = 'aether_state_v5';
const STORAGE_PENDING = 'aether_pending_v5';
const ADS_WINDOW_MS = 12 * 60 * 60 * 1000; // 12h
const ADS_WINDOW_LIMIT = 10;               // <= 10 per 12h
const DAILY_AD_LIMIT = 10;                 // <= 10 per calendar day
const LEVEL_CLAIM_DAILY_LIMIT = 10;        // max 10 level claims per day
const FLUSH_INTERVAL_MS = 2 * 60 * 1000;   // try flush every 2 min
const TON_MANIFEST = 'https://karangangani.github.io/Earncrypto/tonconnect-manifest.json';
const OFFICIAL_CHANNEL_LINK = 'https://t.me/Aetherofficialchannel';

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
const auth = firebase.auth();

/* Telegram WebApp */
const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : { ready:()=>{}, initDataUnsafe:{} };
try { tg.ready(); tg.expand && tg.expand(); } catch(e){}

/* ======= in-memory state ======= */
let current = {
  username: '',
  ae: 0,
  refs: [],
  referredBy: '',
  level: 0,
  adsToday: 0,
  totalAds: 0,
  claimedLevels: [],
  tonWallet: '',
  lastAdTime: 0,
  lastResetDate: new Date().toDateString(),
  multiplierAds: 1,
  multiplierAe: 1,
  giftChosen: false,
  lastSaveTime: Date.now(),
  adsWindowStart: Date.now(),
  adsWindowCount: 0,
  claimedTodayCount: 0,
  lastClaimDate: new Date().toDateString()
};

let userDocId = null;
let tonUI = null;
let levelsRendered = 0;
const startParam = tg.initDataUnsafe && tg.initDataUnsafe.start_param ? tg.initDataUnsafe.start_param : '';

// pending queue
window.__aether_pending = { aeDelta:0, adsDelta:0, refs:[], claimed:[], lastFlush:0 };

/* ======= local storage helpers ======= */
function readStorage() {
  try {
    const s = JSON.parse(localStorage.getItem(STORAGE_STATE) || 'null') || {};
    const p = JSON.parse(localStorage.getItem(STORAGE_PENDING) || 'null') || { aeDelta:0, adsDelta:0, refs:[], claimed:[], lastFlush:0 };
    return { state: s, pending: p };
  } catch (e) { return { state:{}, pending:{ aeDelta:0, adsDelta:0, refs:[], claimed:[], lastFlush:0 } }; }
}
function writeStorage() {
  try {
    localStorage.setItem(STORAGE_STATE, JSON.stringify(current));
    localStorage.setItem(STORAGE_PENDING, JSON.stringify(window.__aether_pending));
  } catch(e){ console.warn('storage write failed', e); }
}

/* load local snapshot */
(function initLocalSnapshot(){
  const { state, pending } = readStorage();
  if (state && Object.keys(state).length) Object.assign(current, state);
  window.__aether_pending = pending || window.__aether_pending;
})();

/* ======= pending queue & flush ======= */
function enqueuePending(aeDelta=0, adsDelta=0, addRef=null, addClaim=null) {
  window.__aether_pending = window.__aether_pending || { aeDelta:0, adsDelta:0, refs:[], claimed:[], lastFlush:0 };
  window.__aether_pending.aeDelta += Number(aeDelta||0);
  window.__aether_pending.adsDelta += Number(adsDelta||0);
  if (addRef) window.__aether_pending.refs.push(addRef);
  if (addClaim) window.__aether_pending.claimed.push(addClaim);
  writeStorage();
}

async function flushPending(force=false) {
  try {
    const p = window.__aether_pending || { aeDelta:0, adsDelta:0, refs:[], claimed:[], lastFlush:0 };
    if (!force && Math.abs(p.aeDelta) < 1 && p.adsDelta === 0 && (!p.refs || p.refs.length===0) && (!p.claimed || p.claimed.length===0)) return;
    const updates = {};
    if (p.aeDelta) updates.ae = firebase.firestore.FieldValue.increment(p.aeDelta);
    if (p.adsDelta) { updates.totalAds = firebase.firestore.FieldValue.increment(p.adsDelta); updates.adsToday = firebase.firestore.FieldValue.increment(p.adsDelta); }
    if (p.refs && p.refs.length) updates.refs = firebase.firestore.FieldValue.arrayUnion(...p.refs);
    if (p.claimed && p.claimed.length) updates.claimedLevels = firebase.firestore.FieldValue.arrayUnion(...p.claimed);
    updates.lastSaveTime = Date.now();
    await db.collection('users').doc(userDocId).update(updates);
    // clear pending
    window.__aether_pending = { aeDelta:0, adsDelta:0, refs:[], claimed:[], lastFlush: Date.now() };
    writeStorage();
    // re-read server to sync authoritative state
    const fresh = await db.collection('users').doc(userDocId).get();
    if (fresh.exists) {
      Object.assign(current, fresh.data());
      writeStorage();
      updateUI();
    }
  } catch (e) {
    console.warn('flushPending failed', e);
    throw e;
  }
}

/* triggers */
setInterval(()=>{ flushPending(false).catch(()=>{}); }, FLUSH_INTERVAL_MS);
window.addEventListener('online', ()=>flushPending(true).catch(()=>{}));
document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState === 'hidden') flushPending(true).catch(()=>{}); });
window.addEventListener('beforeunload', ()=>{ try { writeStorage(); } catch(e){} });

/* ======= ad SDK normalized ======= */
function showAdNormalized(timeoutMs = 30000) {
  return new Promise((resolve) => {
    let done = false;
    const finish = (ok, info) => { if(done) return; done=true; try{window.removeEventListener('libtl_ad_result', eventHandler)}catch(e){}; clearTimeout(timer); resolve({completed:!!ok, info}); };
    const timer = setTimeout(()=>finish(false,'timeout'), timeoutMs);

    try {
      if (window.show_10192178 && typeof window.show_10192178 === 'function') {
        const maybe = window.show_10192178('');
        if (maybe && typeof maybe.then === 'function') {
          maybe.then(res => finish(true,res)).catch(err => finish(false,err));
          return;
        }
      }
    } catch(e){}

    try {
      if (window.libtl && typeof window.libtl.show === 'function') {
        window.libtl.show({
          zone: '10192178',
          onComplete: ()=>finish(true,'libtl_complete'),
          onClose: (watched)=>finish(!!watched,'libtl_close'),
          onError: ()=>finish(false,'libtl_error')
        });
        return;
      }
    } catch(e){}

    const eventHandler = (ev) => {
      try { const ok = !!(ev.detail && (ev.detail.completed || ev.detail.success)); finish(ok, ev.detail); } catch(e){ finish(false,'event error'); }
    };
    window.addEventListener('libtl_ad_result', eventHandler);

    try { if (window.show_10192178 && typeof window.show_10192178 === 'function') window.show_10192178(''); } catch(e){}
  });
}

/* fallback short flow UI */
function fallbackShort(seconds=20) {
  return new Promise((resolve)=>{
    const overlay = document.createElement('div');
    Object.assign(overlay.style,{position:'fixed',left:0,right:0,top:0,bottom:0,background:'rgba(0,0,0,.6)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:99999});
    overlay.innerHTML = `<div style="background:#0f1724;padding:18px;border-radius:12px;color:#fff;text-align:center;max-width:420px;width:90%">
      <h3 style="color:#00d38a">Short flow</h3>
      <p>Ad provider unavailable. Wait <span id="fbcount">${seconds}</span>s to get reward or Cancel.</p>
      <div style="margin-top:12px"><button id="fbcancel" style="padding:8px 12px;border-radius:8px;border:none;background:#333;color:#fff;cursor:pointer">Cancel</button></div>
    </div>`;
    document.body.appendChild(overlay);
    const span = overlay.querySelector('#fbcount');
    const cancelBtn = overlay.querySelector('#fbcancel');
    let rem = seconds;
    const iv = setInterval(()=>{ rem--; span.innerText = rem; if(rem<=0){ clearInterval(iv); document.body.removeChild(overlay); resolve({completed:true}); } },1000);
    cancelBtn.onclick = ()=>{ clearInterval(iv); document.body.removeChild(overlay); resolve({completed:false}); };
  });
}

/* ======= UI helpers ======= */
function updateUI(){
  document.getElementById('points').innerText = Math.floor(current.ae || 0);
  document.getElementById('refs').innerText = (current.refs||[]).length;
  document.getElementById('level').innerText = current.level || 0;
  document.getElementById('levelDisplay').innerText = current.level || 0;
  document.getElementById('totalAds').innerText = current.adsToday || 0;
  document.getElementById('adReward').innerText = 100 * (current.multiplierAds || 1);
}
function openTab(id, ev){ document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); if(ev && ev.currentTarget) ev.currentTarget.classList.add('active'); if(id==='referral'){ loadRefList(); loadLeaderboard(); } if(id==='airdrop') toggleAirdropSection(); }

/* ======= level calculation ======= */
function computeLevel(){
  const refs = (current.refs||[]).length;
  const ads = current.totalAds || 0;
  current.level = Math.min(refs, ads);
  if(!Number.isFinite(current.level) || current.level<0) current.level=0;
}

/* ======= init app ======= */
async function initApp(){
  try{
    await auth.signInAnonymously();
    const tgId = tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id ? tg.initDataUnsafe.user.id.toString() : 'guest_' + Date.now();
    userDocId = tgId;

    const docRef = db.collection('users').doc(userDocId);
    const doc = await docRef.get();
    if(!doc.exists){
      current.username = (tg.initDataUnsafe && tg.initDataUnsafe.user && (tg.initDataUnsafe.user.username || tg.initDataUnsafe.user.first_name)) || 'User';
      await docRef.set(current);
    } else {
      Object.assign(current, doc.data());
    }

    // flush early
    try{ await flushPending(true); } catch(e){ console.warn('startup flush failed', e); }

    computeLevel();
    if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.photo_url){
      const el = document.getElementById('user-dp'); el.src = tg.initDataUnsafe.user.photo_url; el.style.display='block';
    }

    document.getElementById('userLine').innerText = `${current.username || 'User'} â€¢ ID: ${userDocId}`;

    docRef.onSnapshot(snap => {
      if(!snap.exists) return;
      Object.assign(current, snap.data());
      if(window.__aether_pending && window.__aether_pending.aeDelta) current.ae = (current.ae||0) + window.__aether_pending.aeDelta;
      if(window.__aether_pending && window.__aether_pending.adsDelta) current.totalAds = (current.totalAds||0) + window.__aether_pending.adsDelta;
      computeLevel(); updateUI();
    });

    // UI hooks
    document.getElementById('watchAd').onclick = watchAdHandler;
    document.getElementById('showAllLevels').onclick = ()=>renderLevelsChunk(50);
    const refLink = `https://t.me/AetherMineXBot?start=ref_${userDocId}`;
    document.getElementById('myRef').innerText = refLink;
    document.getElementById('copyRef').onclick = ()=>{ navigator.clipboard.writeText(refLink).then(()=>tg.showAlert && tg.showAlert('Copied!')).catch(()=>tg.showAlert && tg.showAlert('Copy failed')); };

    // connect TON UI
    tonUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: TON_MANIFEST, buttonRootId: 'tonBtnRoot' });
    tonUI.onStatusChange(async (wallet)=>{
      if(wallet && wallet.account && wallet.account.address) {
        current.tonWallet = wallet.account.address;
        updateUI();
        enqueuePending(0,0,null,null); writeStorage();
        try{ await flushPending(true); }catch(e){}
      } else {
        current.tonWallet = '';
        updateUI();
      }
    });
    document.getElementById('connectTon').onclick = ()=>tonUI.connectWallet();
    document.getElementById('disconnectTon').onclick = async ()=>{ try{ await tonUI.disconnect(); }catch(e){} current.tonWallet=''; updateUI(); };

    // official website + channel buttons
    document.getElementById('openWebsite').onclick = ()=>{ document.getElementById('websiteModal').style.display='flex'; };
    document.getElementById('visitAppCTA').onclick = ()=>{ document.getElementById('websiteModal').style.display='none'; };
    document.getElementById('openChannelBtn').onclick = async ()=>{
      try { tg.openTelegramLink && tg.openTelegramLink(OFFICIAL_CHANNEL_LINK); } catch(e){}
      // show friendly in-app welcome toast
      showChannelWelcome();
    };
    document.getElementById('joinChannelModalBtn').onclick = async ()=>{
      try { tg.openTelegramLink && tg.openTelegramLink(OFFICIAL_CHANNEL_LINK); } catch(e){}
      showChannelWelcome();
    };

    if(startParam && startParam.startsWith('ref_')) await handleReferral(startParam);

    renderLevelsChunk(20);
    updateUI();
    await loadLeaderboard();
    loadRefList();

    setInterval(async ()=>{ try{ await saveSmallState(); await flushPending(false);}catch(e){} }, 60*1000);

  } catch(e){
    console.error('initApp err', e);
    tg.showAlert && tg.showAlert('Init error: ' + (e.message || e));
  }
}

/* ======= save small state (cheap) ======= */
async function saveSmallState(){
  try{
    await db.collection('users').doc(userDocId).set({
      tonWallet: current.tonWallet || '',
      lastResetDate: current.lastResetDate || new Date().toDateString(),
      lastSaveTime: Date.now(),
      username: current.username || ''
    }, { merge: true });
    writeStorage();
  } catch(e){
    writeStorage();
  }
}

/* ======= watchAd (persist local-first) ======= */
async function watchAdHandler() {
  const now = Date.now();
  const today = new Date().toDateString();
  if (current.lastResetDate !== today) { current.adsToday = 0; current.lastResetDate = today; }
  if (!current.adsWindowStart || now - current.adsWindowStart >= ADS_WINDOW_MS) { current.adsWindowStart = now; current.adsWindowCount = 0; }

  if (current.adsToday >= DAILY_AD_LIMIT) { tg.showAlert && tg.showAlert(`Daily limit: ${DAILY_AD_LIMIT} ads`); return; }
  if (current.adsWindowCount >= ADS_WINDOW_LIMIT) { tg.showAlert && tg.showAlert(`12h window limit: ${ADS_WINDOW_LIMIT} ads`); return; }

  const btn = document.getElementById('watchAd');
  btn.disabled = true;
  const originalText = btn.innerText;
  btn.innerText = 'Loading Ad...';

  const prevAe = current.ae || 0;
  const prevTotalAds = current.totalAds || 0;

  try {
    const res = await showAdNormalized(25000);
    let completed = !!(res && res.completed);

    if (!completed) {
      await new Promise(r=>setTimeout(r,1200));
      completed = (current.ae || 0) > prevAe || (current.totalAds || 0) > prevTotalAds;
    }

    if (!completed) {
      const fb = await fallbackShort(18);
      if (!fb || !fb.completed) {
        tg.showAlert && tg.showAlert('Ad not completed.');
        btn.disabled = false; btn.innerText = originalText;
        return;
      }
    }

    const reward = 100 * (current.multiplierAds || 1);
    current.ae = (current.ae || 0) + reward;
    current.totalAds = (current.totalAds || 0) + 1;
    current.adsToday = (current.adsToday || 0) + 1;
    current.lastAdTime = now;
    current.adsWindowCount = (current.adsWindowCount || 0) + 1;

    enqueuePending(reward, 1, null, null);
    writeStorage();

    try {
      await db.collection('users').doc(userDocId).update({
        ae: firebase.firestore.FieldValue.increment(reward),
        totalAds: firebase.firestore.FieldValue.increment(1),
        adsToday: firebase.firestore.FieldValue.increment(1),
        lastAdTime: now,
        lastSaveTime: Date.now()
      });
      await flushPending(true);
    } catch(writeErr){ console.warn('Immediate ad write failed, will flush later', writeErr); }

    computeLevel();
    updateUI();

    const cooldown = 1000 * (10 + Math.floor(Math.random()*21));
    btn.innerText = `Cooldown ${Math.round(cooldown/1000)}s`;
    setTimeout(()=>{ btn.disabled=false; btn.innerText = originalText; }, cooldown);

    tg.showAlert && tg.showAlert(`+${reward} Ae!`);
  } catch(err) {
    console.warn('watchAdHandler err', err);
    if ((current.ae||0) > prevAe || (current.totalAds||0) > prevTotalAds) {
      computeLevel(); updateUI(); btn.disabled = false; btn.innerText = originalText;
      tg.showAlert && tg.showAlert(`+${(current.ae||0)-prevAe} Ae!`);
      return;
    }
    tg.showAlert && tg.showAlert('Ad failed. Try again later.');
    btn.disabled = false; btn.innerText = originalText;
  }
}

/* ======= levels, claims, leaderboard, referrals ======= */
/* (same code as before) */
function renderLevelsChunk(max) {
  const container = document.getElementById('levelsList');
  const start = levelsRendered + 1;
  const end = levelsRendered + max;
  for (let i=start;i<=end;i++){
    const refsNeeded = i;
    const adsNeeded = i;
    const reward = 500 * i;
    const el = document.createElement('div');
    el.className='level';
    el.innerHTML = `<div style="font-weight:800;color:var(--accent)">Level ${i}</div>
      <div class="small" style="margin-top:8px">Requires: ${refsNeeded} referral${refsNeeded>1?'s':''} & ${adsNeeded} ad${adsNeeded>1?'s':''}</div>
      <div class="small" style="margin-top:8px">Reward: ${reward} Ae</div>
      <div style="margin-top:10px"><button id="claim_${i}" class="claimBtn" disabled>Claim</button></div>`;
    container.appendChild(el);
    document.getElementById(`claim_${i}`).addEventListener('click', ()=>claimLevel(i, refsNeeded, adsNeeded, reward));
  }
  levelsRendered = end;
  updateLevelProgressUI();
  }
  function updateLevelProgressUI(){
  const today = new Date().toDateString();
  if (current.lastClaimDate !== today) { current.claimedTodayCount = 0; current.lastClaimDate = today; }
  const refs = (current.refs||[]).length;
  const ads = current.totalAds || 0;
  for (let i=1;i<=levelsRendered;i++){
    const btn = document.getElementById(`claim_${i}`);
    if (!btn) continue;
    const claimed = (current.claimedLevels||[]).includes(i);
    const canClaim = !claimed && refs >= i && ads >= i && current.claimedTodayCount < LEVEL_CLAIM_DAILY_LIMIT;
    btn.disabled = !canClaim;
    btn.innerText = claimed ? 'Claimed âœ“' : (current.claimedTodayCount >= LEVEL_CLAIM_DAILY_LIMIT ? 'Daily limit reached' : 'Claim');
  }
}

async function claimLevel(levelNo, refsNeeded, adsNeeded, reward) {
  const today = new Date().toDateString();
  if (current.lastClaimDate !== today) { current.claimedTodayCount = 0; current.lastClaimDate = today; }
  if (current.claimedTodayCount >= LEVEL_CLAIM_DAILY_LIMIT) { tg.showAlert && tg.showAlert(`You already claimed ${LEVEL_CLAIM_DAILY_LIMIT} levels today`); return; }

  const refs = (current.refs||[]).length;
  const ads = current.totalAds || 0;
  if (refs < refsNeeded || ads < adsNeeded) { tg.showAlert && tg.showAlert('Requirements not met'); return; }
  if ((current.claimedLevels||[]).includes(levelNo)) { tg.showAlert && tg.showAlert('Already claimed'); return; }

  current.ae = (current.ae||0) + reward;
  current.claimedLevels = current.claimedLevels || [];
  current.claimedLevels.push(levelNo);
  current.claimedTodayCount = (current.claimedTodayCount||0) + 1;
  current.lastClaimDate = today;

  enqueuePending(reward, 0, null, levelNo);
  writeStorage();

  try {
    await db.collection('users').doc(userDocId).update({
      ae: firebase.firestore.FieldValue.increment(reward),
      claimedLevels: firebase.firestore.FieldValue.arrayUnion(levelNo),
      lastSaveTime: Date.now()
    });
    await flushPending(true);
  } catch(e) { console.warn('claim immediate write failed, queued', e); }

  computeLevel();
  updateUI();
  updateLevelProgressUI();
  tg.showAlert && tg.showAlert(`Level ${levelNo} claimed! +${reward} Ae!`);
}

/* leaderboard & refs */
async function loadLeaderboard(){
  try{
    const snap = await db.collection('users').orderBy('ae','desc').limit(100).get();
    const list = document.getElementById('leaderList'); list.innerHTML = '';
    let rank=1;
    snap.forEach(doc=>{
      const d = doc.data();
      const el = document.createElement('div'); el.className='leader-item';
      el.innerHTML = `<span>#${rank} â€¢ ${doc.id}</span><span>${Math.floor(d.ae||0)} Ae</span>`;
      list.appendChild(el); rank++;
    });
  } catch(e){ console.warn('leader load', e); }
}
function loadRefList(){
  const list = document.getElementById('refList'); list.innerHTML = '';
  (current.refs||[]).forEach(r=>{
    const li = document.createElement('li'); li.className='ref-item'; li.innerText = `User ID: ${r}`; list.appendChild(li);
  });
}

/* referral handling */
async function handleReferral(param) {
  try {
    const refid = param.replace('ref_','');
    if (!refid || refid === userDocId) return;
    if (current.referredBy) return;
    const doc = await db.collection('users').doc(refid).get();
    if (!doc.exists) return;
    await db.collection('users').doc(refid).update({ refs: firebase.firestore.FieldValue.arrayUnion(userDocId), ae: firebase.firestore.FieldValue.increment(5000) });
    current.referredBy = refid;
    current.ae = (current.ae||0) + 5000;
    enqueuePending(5000,0,null,null);
    writeStorage();
    try { await flushPending(false); } catch(e){}
    tg.showAlert && tg.showAlert('Referral success! +5000 Ae!');
  } catch(e){ console.warn('handleReferral', e); }
}

/* ======= channel welcome UI ======= */
function showChannelWelcome(){
  const w = document.getElementById('welcomeChannel');
  w.style.display = 'block';
  w.onclick = ()=>{ w.style.display='none'; };
  // auto hide after 10s
  setTimeout(()=>{ try{ w.style.display='none'; }catch(e){} }, 10000);
}

/* ======= start ======= */
initApp();

</script>
</body>
</html>

