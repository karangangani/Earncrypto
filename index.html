<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AETHER — Earn & Airdrop</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css"/>

<style>
:root{ --bg:#000; --panel:#0b0d0f; --muted:#9aa0a6; --accent:#fff; --green:#00d38a }
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,Arial,sans-serif;background:linear-gradient(180deg,#000,#070707);color:var(--muted);padding:14px;min-height:100vh}
.wrap{max-width:720px;margin:12px auto;position:relative}
.header{display:flex;gap:12px;align-items:center;padding:16px;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,0.04),transparent);border:1px solid rgba(255,255,255,0.05)}
.logo{width:72px;height:72px;border-radius:16px;background:linear-gradient(135deg,#00d38a,#00ffaa);display:flex;align-items:center;justify-content:center;color:#000;font-weight:900;font-size:36px;box-shadow:0 4px 20px rgba(0,212,138,0.3)}
h1{color:var(--accent);font-size:20px;font-weight:800}
.sub{color:var(--muted);font-size:14px}
.card{background:var(--panel);padding:16px;border-radius:16px;margin-top:12px;border:1px solid rgba(255,255,255,0.04)}
.stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px}
.stat{padding:14px;background:rgba(255,255,255,0.03);border-radius:12px;text-align:center}
.v{font-weight:800;color:var(--accent);font-size:20px}
.l{font-size:13px;color:var(--muted);margin-top:4px}
.tabs{display:flex;gap:8px;margin:16px 0}
.tab{flex:1;padding:12px;border-radius:12px;text-align:center;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);cursor:pointer;font-weight:600}
.tab.active{background:rgba(255,255,255,0.08);color:var(--accent);border-color:var(--green)}
.section{display:none}
.section.active{display:block}
button.btn{width:100%;padding:14px;border-radius:14px;border:none;background:linear-gradient(90deg,#fff,#dfeaf6);color:#000;font-weight:800;font-size:16px;cursor:pointer;margin:8px 0}
button.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.1);padding:10px;border-radius:10px}
.ref-box{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);margin:12px 0}
.levels{display:grid;gap:10px;margin-top:12px}
.level{padding:14px;border-radius:12px;background:rgba(255,255,255,0.03)}
.claimBtn{background:var(--green);color:#000;padding:10px 20px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
.claimBtn:disabled{background:#333;color:#666}
.small{font-size:13px;color:var(--muted);margin-top:8px}
.footer{margin-top:20px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="logo">A</div>
    <div>
      <h1>AETHER</h1>
      <div id="userLine" class="sub">Loading...</div>
    </div>
  </div>

  <div class="card">
    <div class="stats">
      <div class="stat"><div class="v" id="points">0</div><div class="l">Coins</div></div>
      <div class="stat"><div class="v" id="refs">0</div><div class="l">Referrals</div></div>
      <div class="stat"><div class="v" id="level">1</div><div class="l">Level</div></div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="openTab('home')">Home</div>
      <div class="tab" onclick="openTab('tasks')">Tasks</div>
      <div class="tab" onclick="openTab('referral')">Referral</div>
      <div class="tab" onclick="openTab('wallet')">Wallet</div>
    </div>

    <div id="home" class="section active">
      <button id="startMining" class="btn">Start Mining Now</button>
      <p class="small">Passive earning active • Come back daily for bonus</p>
    </div>

    <div id="tasks" class="section">
      <button id="watchAd" class="btn">Watch Ad (+50 Coins)</button>
      <p class="small">Daily: <span id="adsToday">0</span> / <span id="adsLimit">20</span> • Total: <span id="totalAds">0</span></p>

      <div class="ref-box" style="margin-top:16px">
        <div>Join Channel (no reward):</div>
        <button id="openChannel" class="ghost">Open</button>
      </div>

      <div style="margin:16px 0 8px;font-weight:700;color:var(--accent)">Level Rewards</div>
      <div id="levelsList" class="levels"></div>
    </div>

    <div id="referral" class="section">
      <h3 style="color:var(--green);margin-bottom:8px">+500 Coins Per Referral!</h3>
      <div class="ref-box">
        <div id="myRef" style="color:var(--accent);font-size:14px">Loading link...</div>
        <button id="copyRef" class="ghost">COPY</button>
      </div>
    </div>

    <div id="wallet" class="section">
      <button id="connectTon" class="btn">Connect TON Wallet</button>
      <div id="walletStatus" class="small" style="margin:12px 0">Not connected</div>
      <div id="tonBtnRoot"></div>
      <p class="small">Need 10 referrals + 5,000 coins for airdrop</p>
    </div>
  </div>

  <div class="footer">© 2025 AETHER • @AetherMineXBot</div>
</div>

<script>
const firebaseConfig = {apiKey:"AIzaSyBRMiyuGkjDFfZE9tqgzGVWJalw_6Cypz4",authDomain:"earncryptomp.firebaseapp.com",projectId:"earncryptomp",storageBucket:"earncryptomp.firebasestorage.app",messagingSenderId:"405204250643",appId:"1:405204250643:web:8841299bceb46f6752cfe6"};
const BOT_TOKEN = "8359547898:AAGwkv22tGbWQZQChk8buqQnXXjC9i0ErDg";
const REF_BONUS = 500;

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

let uid = null;
let user = {};

auth.signInAnonymously().then(cred => {
  uid = cred.user.uid;
  initUser();
});

async function initUser() {
  const userRef = db.collection('users').doc(uid);
  const snap = await userRef.get();

  if (!snap.exists) {
    const tgId = tg.initDataUnsafe.user?.id || null;
    const username = tg.initDataUnsafe.user?.username || tg.initDataUnsafe.user?.first_name || 'User';
    await userRef.set({
      telegramId: tgId,
      username,
      coins: 0,
      refs: [],
      level: 1,
      adsToday: 0,
      totalAds: 0,
      tonWallet: '',
      lastActive: new Date(),
      claimedLevels: []
    });
  }

  // REFERRAL SYSTEM (100% WORKING)
  const startParam = tg.initDataUnsafe.start_param;
  if (startParam?.startsWith('ref_')) {
    const refTgId = parseInt(startParam.split('_')[1]);
    if (refTgId && refTgId !== tg.initDataUnsafe.user?.id) {
      const refSnap = await db.collection('users').where('telegramId', '==', refTgId).limit(1).get();
      if (!refSnap.empty && !(await userRef.get()).data()).referredBy) {
        const refDoc = refSnap.docs[0];
        await db.runTransaction(async t => {
          t.update(refDoc.ref, {
            coins: firebase.firestore.FieldValue.increment(REF_BONUS),
            refs: firebase.firestore.FieldValue.arrayUnion(uid)
          });
          t.update(userRef, { referredBy: refDoc.id });
        });
        tg.showAlert("Referral successful! +500 coins added to friend!");
      }
    }
  }

  // Referral link
  const link = `https://t.me/AetherMineXBot?startapp=ref_${tg.initDataUnsafe.user?.id || uid}`;
  document.getElementById('myRef').textContent = link;
  document.getElementById('copyRef').onclick = () => { navigator.clipboard.writeText(link); tg.showAlert("Copied!"); };

  document.getElementById('userLine').textContent = `@\( {tg.initDataUnsafe.user?.username || 'user'} • Level \){snap.data()?.level || 1}`;

  // Listeners
  userRef.onSnapshot(doc => {
    user = doc.data();
    updateUI();
    renderLevels();
  });

  document.getElementById('watchAd').onclick = () => {
    if (user.adsToday >= (20 + (user.level-1)*10)) return tg.showAlert("Limit reached!");
    db.collection('users').doc(uid).update({
      coins: firebase.firestore.FieldValue.increment(50),
      adsToday: firebase.firestore.FieldValue.increment(1),
      totalAds: firebase.firestore.FieldValue.increment(1)
    });
    tg.showAlert("+50 Coins!");
  };

  document.getElementById('openChannel').onclick = () => tg.openTelegramLink('https://t.me/AetherMineX');
}

function updateUI() {
  document.getElementById('points').textContent = (user.coins||0).toLocaleString();
  document.getElementById('refs').textContent = user.refs?.length || 0;
  document.getElementById('level').textContent = user.level || 1;
  document.getElementById('adsToday').textContent = user.adsToday || 0;
  document.getElementById('totalAds').textContent = user.totalAds || 0;
  document.getElementById('adsLimit').textContent = 20 + (user.level-1)*10;
  if (user.tonWallet) document.getElementById('walletStatus').textContent = `Connected: \( {user.tonWallet.slice(0,8)}... \){user.tonWallet.slice(-6)}`;
}

function renderLevels() {
  const list = document.getElementById('levelsList');
  list.innerHTML = '';
  const refs = user.refs?.length || 0;
  const ads = user.totalAds || 0;
  for(let i=1; i<=30; i++) {
    const needRefs = i;
    const needAds = 10 + i*5;
    const reward = 500 * i;
    const claimed = user.claimedLevels?.includes(i);
    const can = refs >= needRefs && ads >= needAds && !claimed;
    const div = document.createElement('div');
    div.className = 'level';
    div.innerHTML = `
      <div style="font-weight:700;color:var(--accent)">Level ${i}</div>
      <div class="small">Need \( {needRefs} refs & \){needAds} ads → <b>${reward.toLocaleString()} coins</b></div>
      <button class="claimBtn" \( {can?'':'disabled'} onclick="claimLevel( \){i})">
        ${can?'Claim':claimed?'Claimed':'Locked'}
      </button>
    `;
    list.appendChild(div);
  }
}

async function claimLevel(lvl) {
  const needRefs = lvl;
  const needAds = 10 + lvl*5;
  if ((user.refs?.length || 0) < needRefs || (user.totalAds || 0) < needAds || user.claimedLevels?.includes(lvl)) return;
  await db.collection('users').doc(uid).update({
    coins: firebase.firestore.FieldValue.increment(500*lvl),
    level: firebase.firestore.FieldValue.increment(1),
    claimedLevels: firebase.firestore.FieldValue.arrayUnion(lvl)
  });
  tg.showAlert(`Level \( {lvl} claimed! + \){(500*lvl).toLocaleString()} coins`);
}

function openTab(id) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.target.classList.add('active');
}
</script>
</body>
</html>
