<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Aether 1.1 — User</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- TONCONNECT UI -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css"/>

  <!-- REWARDED ADS SDK (your snippet) -->
  <script src='//libtl.com/sdk.js' data-zone='10192178' data-sdk='show_10192178'></script>

  <style>
    /* minimal dark theme; keep as you like */
    body{font-family:Arial,background:#000;color:#ddd;padding:12px}
    .card{background:#0f0f10;padding:14px;border-radius:12px;margin:10px 0;border:1px solid #222}
    .btn{background:#00ff88;color:#000;padding:12px;border-radius:10px;border:none;font-weight:700;cursor:pointer;width:100%}
    .muted{color:#888;font-size:13px}
    .stats{display:flex;gap:8px}
    .stat{flex:1;padding:8px;background:#121214;border-radius:8px;text-align:center}
  </style>
</head>
<body>
  <h2 style="color:#fff">Aether — Earn & Airdrop (1.1)</h2>

  <div class="card">
    <div id="who" class="muted">Loading user...</div>
    <div class="stats" style="margin-top:10px">
      <div class="stat"><div id="coins" style="font-weight:800">0</div><div class="muted">Coins</div></div>
      <div class="stat"><div id="refs" style="font-weight:800">0</div><div class="muted">Referrals</div></div>
      <div class="stat"><div id="lvl" style="font-weight:800">1</div><div class="muted">Level</div></div>
    </div>
  </div>

  <div class="card">
    <button id="startMining" class="btn">Start Passive Earning</button>
    <div class="muted" style="margin-top:8px">Passive mining adds 1 coin/sec while running (client updates server).</div>
  </div>

  <div class="card">
    <button id="watchAd" class="btn">Watch Rewarded Ad (+50)</button>
    <div class="muted" style="margin-top:8px">Daily limit applies. Milestone bonuses at 10,20,50.</div>
    <div style="margin-top:8px" class="muted">Ads today: <span id="adsToday">0</span> / <span id="adsLimit">20</span></div>
  </div>

  <div class="card">
    <div style="display:flex;gap:8px;">
      <div style="flex:1"><button id="connectTon" class="btn">Connect TON Wallet</button></div>
      <div style="width:120px"><div id="tonBtnRoot"></div></div>
    </div>
    <div id="walletStatus" class="muted" style="margin-top:8px">Wallet not connected</div>
  </div>

  <div class="card">
    <div class="muted">Referral</div>
    <div style="margin-top:8px" id="myRef">Generating...</div>
    <button id="copyRef" class="btn" style="margin-top:8px">Copy Referral Link</button>
    <div class="muted" style="margin-top:8px">Share your link. First-time joins only count.</div>
  </div>

<script>
/* ================== CONFIG ================== */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBRMiyuGkjDFfZE9tqgzGVWJalw_6Cypz4",
  authDomain: "earncryptomp.firebaseapp.com",
  projectId: "earncryptomp",
  storageBucket: "earncryptomp.firebasestorage.app",
  messagingSenderId: "405204250643",
  appId: "1:405204250643:web:8841299bceb46f6752cfe6"
};
const AD_FN = 'show_10192178';    // ad function provided by your SDK
const DAILY_BASE = 20;            // base daily ad limit
const ADS_COOLDOWN_MS = 5000;     // 5s between ads
const TON_MANIFEST = 'https://karangangani.github.io/Earncrypto/tonconnect-manifest.json';
/* ============================================ */

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
const auth = firebase.auth();

// Telegram (if running as telegram webapp)
const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
if (tg) tg.ready();
const tgUser = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) || {};

// read start param from many possible sources
const startParam = (tg && (tg.initDataUnsafe.start_param || tg.initDataUnsafe.startapp)) || new URLSearchParams(window.location.search).get('start') || new URLSearchParams(window.location.search).get('startapp') || '';

// local state
let firebaseUid = null;
let current = {
  coins:0, refs:[], level:1, adsToday:0, lastAdTime:0, adsMilestones:[], claimedLevels:[], tonWallet:'', refCode:''
};
let adLastTime = 0;
let mining=false;

/* sign-in anonymous */
auth.signInAnonymously().then(()=> {
  firebaseUid = auth.currentUser.uid;
  init();
}).catch(e=>{
  console.error('auth err',e);
  firebaseUid = 'anon_'+Date.now();
  init();
});

function userRef(){ return db.collection('users').doc(firebaseUid); }

async function init(){
  // create user doc if not exists
  const doc = await userRef().get();
  if (!doc.exists) {
    // prefer stable refCode: use telegram id if available else random
    const preferRef = (tgUser && tgUser.id) ? tgUser.id.toString() : null;
    const refCode = preferRef || ('AM' + Math.random().toString(36).substr(2,6).toUpperCase());
    await userRef().set({
      firebaseUid,
      telegramId: tgUser.id || null,
      username: tgUser.username || tgUser.first_name || null,
      refCode,
      coins:0,
      refs:[],
      referredBy: null,
      level:1,
      adsToday:0,
      adsMilestones:[],
      claimedLevels:[],
      tonWallet:'',
      lastLogin: null,
      joinedChannel:false
    }, {merge:true});
  }

  // realtime listener keeps UI syncd
  userRef().onSnapshot(docsnap=>{
    if (!docsnap.exists) return;
    const d = docsnap.data();
    current.coins = d.coins || 0;
    current.refs = d.refs || [];
    current.level = d.level || 1;
    current.adsToday = d.adsToday || 0;
    current.adsMilestones = d.adsMilestones || [];
    current.claimedLevels = d.claimedLevels || [];
    current.tonWallet = d.tonWallet || '';
    current.refCode = d.refCode || current.refCode || ('AM' + Math.random().toString(36).substr(2,6).toUpperCase());
    // render
    renderUI();
  }, e => console.warn('snap err',e));

  // set referral link on UI
  setupReferralUI();

  // TON UI init - button will be auto-mounted inside #tonBtnRoot
  if (window.TON_CONNECT_UI) {
    const tonUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: TON_MANIFEST,
      buttonRootId: 'tonBtnRoot'
    });
    if (tonUI && typeof tonUI.onStatusChange === 'function') {
      tonUI.onStatusChange(async (wallet) => {
        if (wallet && wallet.account) {
          const addr = wallet.account.address || wallet.account;
          try { await userRef().update({ tonWallet: addr, lastWalletUpdate: Date.now() }); }
          catch(e){ console.error('save wallet', e); }
          if (tg) tg.showAlert('TON wallet connected');
        }
      });
    }
    document.getElementById('connectTon').onclick = ()=> { if (tonUI && tonUI.connectWallet) tonUI.connectWallet(); else alert('TON UI not available'); };
  } else {
    document.getElementById('connectTon').onclick = ()=> alert('TON UI not loaded');
  }

  // handle start param (referral)
  await handleReferralParam();

  // handlers
  document.getElementById('copyRef').onclick = ()=> {
    const bot = 'AetherMineX';
    const link = `https://t.me/${bot}?startapp=ref_${ (tgUser && tgUser.id) ? tgUser.id.toString() : firebaseUid }`;
    navigator.clipboard.writeText(link);
    if (tg) tg.showAlert('Referral link copied'); else alert('Copied');
  };
  document.getElementById('watchAd').onclick = watchAdHandler;
  document.getElementById('startMining').onclick = startPassive;
}

/* render UI */
function renderUI(){
  document.getElementById('who').innerText = ((tgUser.username ? '@'+tgUser.username : (tgUser.first_name || 'Guest')) + ' • ' + (current.refCode || ''));
  document.getElementById('coins').innerText = Math.floor(current.coins || 0);
  document.getElementById('refs').innerText = (current.refs && current.refs.length) || 0;
  document.getElementById('lvl').innerText = current.level || 1;
  document.getElementById('adsToday').innerText = current.adsToday || 0;
  const dailyLimit = DAILY_BASE + (Math.max(0,(current.level||1)-1) * 20);
 document.getElementById('adsLimit').innerText = dailyLimit;
  document.getElementById('myRef').innerText = `https://t.me/AetherMineX?startapp=ref_${ (tgUser && tgUser.id) ? tgUser.id.toString() : firebaseUid }`;
  if (current.tonWallet) document.getElementById('walletStatus').innerText = `TON: ${current.tonWallet.slice(0,6)}...${current.tonWallet.slice(-4)}`;
}

/* referral handling (robust) */
async function handleReferralParam(){
  try {
    if (!startParam || !startParam.startsWith('ref_')) return;
    const raw = startParam.split('_')[1];
    if (!raw) return;

    // refresh myself
    const me = await userRef().get();
    const meData = me.exists ? me.data() : {};
    if (meData.referredBy) return; // already referred

    // avoid self-ref
    if (raw === firebaseUid) return;
    if (tgUser && tgUser.id && raw === tgUser.id.toString()) return;

    // try doc id
    let refDocSnap = await db.collection('users').doc(raw).get();
    if (!refDocSnap.exists) {
      // try find by telegramId
      const s = await db.collection('users').where('telegramId','==', raw).limit(1).get();
      if (!s.empty) refDocSnap = s.docs[0];
    }
    if (!refDocSnap.exists) {
      // try by refCode
      const s2 = await db.collection('users').where('refCode','==', raw).limit(1).get();
      if (!s2.empty) refDocSnap = s2.docs[0];
    }
    if (!refDocSnap.exists) return;

    const refId = refDocSnap.id;
    if (refId === firebaseUid) return; // double check

    // update referrer atomically: add my uid to their refs[] and add coins
    await db.collection('users').doc(refId).update({
      refs: firebase.firestore.FieldValue.arrayUnion(firebaseUid),
      coins: firebase.firestore.FieldValue.increment(500)
    });

    // mark me referredBy to prevent double count
    await userRef().set({ referredBy: refId }, { merge:true });

    if (tg) tg.showAlert('Referral applied: referrer +500 coins');
  } catch(e){ console.error('referral', e); }
}

/* ADS logic */
async function watchAdHandler(){
  try {
    // get fresh data
    const snap = await userRef().get();
    const data = snap.exists ? snap.data() : {};
    let adsTodayLocal = data.adsToday || 0;
    const lastAd = data.lastAdTime || 0;

    const now = Date.now();
    const oneDay = 24*60*60*1000;
    if (lastAd && now - lastAd > oneDay) adsTodayLocal = 0;

    const dailyLimit = DAILY_BASE + (Math.max(0,(data.level||1)-1) * 20);
    if (adsTodayLocal >= dailyLimit) { if (tg) tg.showAlert('Daily ad limit reached'); else alert('limit reached'); return; }
    if (now - adLastTime < ADS_COOLDOWN_MS) { if (tg) tg.showAlert('Please wait a few seconds'); return; }
    adLastTime = now;

    document.getElementById('watchAd').innerText = 'Loading ad...'; document.getElementById('watchAd').disabled=true;

    if (typeof window[AD_FN] === 'function') {
      try {
        await window[AD_FN]('pop');
      } catch(e) {
        console.error('ad failed',e); if (tg) tg.showAlert('Ad failed'); document.getElementById('watchAd').innerText='Watch Rewarded Ad (+50)'; document.getElementById('watchAd').disabled=false; return;
      }
    } else {
      // fallback simulate
      await new Promise(r=>setTimeout(r,1500));
    }

    // reward
    adsTodayLocal++;
    let milestoneBonus = 0;
    const M = {10:500,20:1000,50:3000};
    if (M[adsTodayLocal]) milestoneBonus = M[adsTodayLocal];

    await userRef().update({
      coins: firebase.firestore.FieldValue.increment(50 + milestoneBonus),
      adsToday: adsTodayLocal,
      adsMilestones: firebase.firestore.FieldValue.arrayUnion(adsTodayLocal),
      lastAdTime: now
    });

    if (tg) tg.showAlert(`+50 ${milestoneBonus?('+'+milestoneBonus+' bonus') : ''}`);
    document.getElementById('watchAd').innerText='Watch Rewarded Ad (+50)'; document.getElementById('watchAd').disabled=false;
  } catch(e){ console.error('watchAdHandler', e); document.getElementById('watchAd').innerText='Watch Rewarded Ad (+50)'; document.getElementById('watchAd').disabled=false; }
}

/* passive mining */
function startPassive(){
  if (mining) return;
  mining=true;
  setInterval(async ()=>{
    try { await userRef().update({ coins: firebase.firestore.FieldValue.increment(1) }); } catch(e){ console.warn('mining update fail',e); }
  }, 1000);
}
</script>
</body>
</html>
