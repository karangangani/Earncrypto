<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AetherMine — Wallet, Referral & Ads (Merged)</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- TONConnect UI (latest) -->
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css"/>

<!-- Ad SDK (your snippet) -->
<script src='//libtl.com/sdk.js' data-zone='10192178' data-sdk='show_10192178'></script>

<style>
  :root{
    --bg:#000; --panel:#0b0c0d; --muted:#9aa0a6; --accent:#fff; --green:#00ff88; --glass:rgba(255,255,255,0.02);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(180deg,#000,#060606);color:var(--muted);font-family:Inter,Arial,sans-serif;padding:12px;min-height:100vh}
  .wrap{max-width:720px;margin:12px auto}
  .top{display:flex;gap:12px;align-items:center}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#111,#222);display:flex;align-items:center;justify-content:center;color:var(--green);font-weight:900}
  h1{color:var(--accent);font-size:20px}
  .card{background:var(--panel);border-radius:12px;padding:14px;margin-top:12px;border:1px solid rgba(255,255,255,0.03)}
  .stats{display:flex;gap:10px;justify-content:space-between}
  .stat{flex:1;padding:12px;background:var(--glass);border-radius:8px;text-align:center}
  .v{font-weight:800;color:var(--green);font-size:18px}
  .tabs{display:flex;gap:8px;margin-top:12px}
  .tab{flex:1;padding:10px;border-radius:10px;text-align:center;background:transparent;border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--muted)}
  .tab.active{background:rgba(255,255,255,0.02);color:var(--accent)}
  .section{display:none;padding-top:12px}
  .section.active{display:block}
  .btn{background:linear-gradient(90deg,#fff,#e6eef8);color:#051;padding:12px;border-radius:10px;border:none;font-weight:700;cursor:pointer;width:100%}
  .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
  .small{font-size:13px;color:var(--muted);margin-top:8px;text-align:center}
  .ref-box{display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.01);border-radius:8px}
  .ref-link{color:var(--green);word-break:break-all}
  .levels{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-top:12px}
  .level{padding:10px;border-radius:8px;background:rgba(255,255,255,0.01)}
  .claim{background:var(--green);color:#001;padding:8px;border-radius:8px;border:none;cursor:pointer}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .wallet-box{margin-top:10px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.01)}
  @media (max-width:480px){ .top{flex-direction:column;align-items:flex-start} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo" id="logo">Ae</div>
      <div>
        <h1>AETHER — Mine & Airdrop</h1>
        <div id="userLine" class="small">Loading...</div>
      </div>
    </div>

    <div class="card">
      <div class="stats">
        <div class="stat"><div class="v" id="points">0</div><div class="l">Points</div></div>
        <div class="stat"><div class="v" id="refs">0</div><div class="l">Referrals</div></div>
        <div class="stat"><div class="v" id="level">1</div><div class="l">Level</div></div>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="openTab('home')">Home</div>
        <div class="tab" onclick="openTab('tasks')">Tasks</div>
        <div class="tab" onclick="openTab('referral')">Referral</div>
        <div class="tab" onclick="openTab('airdrop')">Airdrop</div>
      </div>

      <!-- HOME -->
      <div id="home" class="section active">
        <div style="display:flex;gap:10px;align-items:center">
          <div style="flex:1">
            <button id="startMining" class="btn">Start Earning (Passive)</button>
            <p class="small">Daily login streak gives bonus for 7 days. Levels give extra claim rewards.</p>
          </div>
          <div style="width:90px;text-align:center">
            <div style="width:64px;height:64px;border-radius:10px;background:linear-gradient(135deg,#111,#222);display:flex;align-items:center;justify-content:center;color:var(--green)">Ae</div>
          </div>
        </div>
      </div>

      <!-- TASKS -->
      <div id="tasks" class="section">
        <button id="watchAd" class="btn">Watch Rewarded Ad (+50)</button>
        <p class="small">Daily ads watched: <span id="adsToday">0</span> / <span id="adsLimit">20</span></p>
        <div class="levels" id="levels"></div>
      </div>

      <!-- REFERRAL -->
      <div id="referral" class="section">
        <div class="ref-box">
          <div class="ref-link" id="myRef">Generating...</div>
          <div><button id="copyRef" class="btn ghost">COPY</button></div>
        </div>
        <p class="small">Invite friends using your unique link. First-time joins count.</p>
      </div>

      <!-- AIRDROP / WALLET -->
      <div id="airdrop" class="section">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div id="tonConnectBtn" style="min-width:220px"></div>
          <button id="pasteWallet" class="btn ghost" style="min-width:180px">Paste Wallet (Manual)</button>
        </div>

        <div class="wallet-box">
          <div id="walletStatus">Not Connected</div>
          <div class="small" id="chainBalance"></div>
        </div>

        <div style="margin-top:12px">
          <button id="showBalance" class="btn ghost">Show Balance</button>
        </div>

        <p class="small">Eligibility for airdrop: 10 referrals + 5000 points</p>
      </div>

    </div>

    <footer>© AetherMine — Bot: @AetherMineXBot</footer>
  </div>
  <script>
/* ================== CONFIG ================== */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBRMiyuGkjDFfZE9tqgzGVWJalw_6Cypz4",
  authDomain: "earncryptomp.firebaseapp.com",
  projectId: "earncryptomp",
  storageBucket: "earncryptomp.firebasestorage.app",
  messagingSenderId: "405204250643",
  appId: "1:405204250643:web:8841299bceb46f6752cfe6"
};
const BOT_USERNAME = "AetherMineXBot";
const AD_SDK_FN = "show_10192178";   // ad function (keep the script include)
const DAILY_AD_LIMIT_BASE = 20;
const ADS_COOLDOWN_MS = 5000;
const LEVELS_MAX = 100;
const TON_MANIFEST_URL = "https://karangangani.github.io/Earncrypto/tonconnect-manifest.json";
/* =========================================== */

// init firebase (compat)
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
const auth = firebase.auth();

// Telegram
const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
if (tg) tg.ready();
const tgUser = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) || {};

// state
let firebaseUid = null;
let current = { points:0, refs:[], level:1, adsToday:0, adsMilestones:[], wallet:"", tonWallet:"", lastLogin:null, streak:0, joinedChannel:false, claimedLevels:[], refCode:'' };

// read start param robustly
const startParam = (tg && (tg.initDataUnsafe.start_param || tg.initDataUnsafe.startapp)) || new URLSearchParams(window.location.search).get('start') || new URLSearchParams(window.location.search).get('startapp') || '';

// anonymous auth -> then init
auth.signInAnonymously().then(()=>{ firebaseUid = auth.currentUser.uid; initApp(); }).catch((e)=>{ console.error("auth err",e); firebaseUid = "anon_"+Date.now(); initApp(); });

function userDocRef(){ return db.collection('users').doc(firebaseUid); }

async function initApp(){
  try {
    // create or load user doc
    const doc = await userDocRef().get();
    if (!doc.exists) {
      const preferRef = (tgUser && tgUser.id) ? tgUser.id.toString() : null;
      const refCode = preferRef || ('AM' + Math.random().toString(36).substr(2,6).toUpperCase());
      current.refCode = refCode;
      await userDocRef().set({
        firebaseUid,
        telegramId: (tgUser && tgUser.id) ? tgUser.id.toString() : null,
        username: (tgUser && (tgUser.username || tgUser.first_name)) || null,
        refCode,
        points:0, refs:[], level:1, adsToday:0, adsMilestones:[], wallet:"", tonWallet:"", lastLogin:null, streak:0, joinedChannel:false, claimedLevels:[]
      }, { merge:true });
    } else {
      const data = doc.data();
      current = {
        points: data.points || 0,
        refs: data.refs || [],
        level: data.level || 1,
        adsToday: data.adsToday || 0,
        adsMilestones: data.adsMilestones || [],
        wallet: data.wallet || "",
        tonWallet: data.tonWallet || "",
        lastLogin: data.lastLogin || null,
        streak: data.streak || 0,
        joinedChannel: data.joinedChannel || false,
        claimedLevels: data.claimedLevels || [],
        refCode: data.refCode || ''
      };
    }

    // build referral link (prefer telegram id like BUGminer)
    const refIdForLink = ((tgUser && tgUser.id) ? tgUser.id.toString() : firebaseUid);
    const myRefLink = `https://t.me/${BOT_USERNAME}?startapp=ref_${refIdForLink}`;
    document.getElementById('myRef').innerText = myRefLink;
    document.getElementById('copyRef').onclick = ()=>{ navigator.clipboard.writeText(myRefLink); if (tg) tg.showAlert("Link copied"); else alert("Copied"); };

    // TONConnect UI setup
    setupTonConnect();

    // levels UI
    renderLevels();

    // handle referral param (credit referrer)
    await handleReferralParam();

    updateUI();
    checkDailyLogin();
  } catch (e) {
    console.error("initApp err", e);
    if (tg) tg.showAlert("Init error");
  }
}

/* -------- REFERRAL HANDLING (works like BUGminer) -------- */
async function handleReferralParam(){
  try {
    if (!startParam || !startParam.startsWith('ref_')) return;
    const refId = startParam.split('_')[1];
    if (!refId) return;

    // prevent double apply
    const meDoc = await userDocRef().get(); const meData = meDoc.exists ? meDoc.data() : {};
    if (meData.referredBy) return;
    if (refId === firebaseUid) return;
    if (tgUser && tgUser.id && refId === tgUser.id.toString()) return;

    // try to find referrer doc by doc id or telegramId
    let refDocSnap = await db.collection('users').doc(refId).get();
    if (!refDocSnap.exists) {
      const snap = await db.collection('users').where('telegramId','==',refId).limit(1).get();
      if (!snap.empty) refDocSnap = snap.docs[0];
      else return;
    }
    const refDocId = refDocSnap.id;

    // credit referrer and mark me
    await db.collection('users').doc(refDocId).update({
      refs: firebase.firestore.FieldValue.arrayUnion(firebaseUid),
      points: firebase.firestore.FieldValue.increment(500)
    });
    await userDocRef().set({ referredBy: refDocId }, { merge:true });

    if (tg) tg.showAlert("Referral applied. Referrer +500 pts");
  } catch (e) { console.error("handleReferralParam", e); }
}

/* -------- DAILY LOGIN (7-day streak) -------- */
const BONUS = [100,200,300,400,500,700,1000];
async function checkDailyLogin(){
  try {
    const today = new Date().toDateString();
    if (current.lastLogin !== today) {
      const streak = (current.streak % 7) + 1;
      const bonus = BONUS[streak-1] || 100;
      current.points += bonus;
      current.streak = streak;
      current.lastLogin = today;
      current.adsToday = 0;
      current.adsMilestones = [];
      await userDocRef().update({ points: current.points, streak: current.streak, lastLogin: today, adsToday:0, adsMilestones: [] });
      if (tg) tg.showAlert(`Day ${streak} Bonus: +${bonus} pts`);
    }
    updateUI();
  } catch(e){ console.error("daily err", e); }
}

/* -------- UI update, tabs -------- */
function updateUI(){
  document.getElementById('points').innerText = Math.floor(current.points || 0);
  document.getElementById('refs').innerText = (current.refs && current.refs.length) || 0;
  document.getElementById('level').innerText = current.level || 1;
  document.getElementById('adsToday').innerText = current.adsToday || 0;
  document.getElementById('adsLimit').innerText = DAILY_AD_LIMIT_BASE;
  document.getElementById('userLine').innerText = (tgUser.username ? '@'+tgUser.username : (tgUser.first_name || 'Guest')) + ' • ' + (current.refCode || '');
  if (current.tonWallet) document.getElementById('walletStatus').innerText = `TON: ${current.tonWallet.slice(0,6)}...${current.tonWallet.slice(-4)}`;
  else if (current.wallet) document.getElementById('walletStatus').innerText = `${current.wallet.slice(0,6)}...${current.wallet.slice(-4)}`;
}

function openTab(tab){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`[onclick="openTab('${tab}')"]`).classList.add('active');
}

/* -------- LEVELS (renders first 20 for performance) -------- */
function renderLevels(){
  const container = document.getElementById('levels'); container.innerHTML = '';
  const showCount = 20;
  for (let i=1;i<=Math.min(LEVELS_MAX, showCount);i++){
    const refsNeeded = i;
    const adsNeeded = 10 + (i*5);
    const reward = i*1000;
    const el = document.createElement('div'); el.className='level';
    el.innerHTML = `<div style="font-weight:700;color:#fff">Level ${i}</div><div class="small">Need ${refsNeeded} refs & ${adsNeeded} ads — Reward ${reward} pts</div><div style="margin-top:8px"><button id="claim_${i}" class="claim" disabled>Claim</button></div>`;
    container.appendChild(el);
    document.getElementById(`claim_${i}`).onclick = ()=> claimLevel(i, refsNeeded, adsNeeded, reward);
  }
  setInterval(updateLevelProgress,1500);
}

async function updateLevelProgress(){
  try {
    const snap = await userDocRef().get();
    const data = snap.exists ? snap.data() : {};
    const refsCount = (data.refs && data.refs.length) || 0;
    const adsDone = data.adsToday || 0;
    for (let i=1;i<=Math.min(20,LEVELS_MAX);i++){
      const refsNeeded = i; const adsNeeded = 10 + (i*5);
      const claimBtn = document.getElementById(`claim_${i}`);
      if (!claimBtn) continue;
      const claimed = (data.claimedLevels || []).includes(i);
      claimBtn.disabled = claimed || !(refsCount>=refsNeeded && adsDone>=adsNeeded);
      claimBtn.innerText = claimed ? 'Claimed' : 'Claim';
    }
  } catch(e){ console.error(e); }
}

async function claimLevel(levelNo, refsNeeded, adsNeeded, reward){
  try {
    const snap = await userDocRef().get();
    const data = snap.exists ? snap.data() : {};
    const refsCount = (data.refs && data.refs.length) || 0;
    const adsDone = data.adsToday || 0;
    if (refsCount < refsNeeded || adsDone < adsNeeded){ if (tg) tg.showAlert('Requirements not met'); else alert('Requirements not met'); return; }
    const claimed = data.claimedLevels || [];
    if (claimed.includes(levelNo)){ if (tg) tg.showAlert('Already claimed'); else alert('Already claimed'); return; }
    await userDocRef().update({ points: firebase.firestore.FieldValue.increment(reward), claimedLevels: firebase.firestore.FieldValue.arrayUnion(levelNo) });
    current.points += reward; updateUI();
    if (tg) tg.showAlert(`Level ${levelNo} claimed: +${reward} pts`);
  } catch(e){ console.error("claim err",e); if (tg) tg.showAlert("Claim failed"); else alert("Claim failed"); }
}

/* -------- ADS logic (with cooldown + milestones) -------- */
let lastAdTime = 0;
document.getElementById('watchAd').onclick = async ()=>{
  try {
    const limit = DAILY_AD_LIMIT_BASE;
    if ((current.adsToday||0) >= limit) return (tg ? tg.showAlert("Daily ad limit reached") : alert("Daily ad limit reached"));
    const now = Date.now();
    if (now - lastAdTime < ADS_COOLDOWN_MS) return (tg ? tg.showAlert("Please wait a few seconds between ads") : alert("Please wait"));
    lastAdTime = now;
    const btn = document.getElementById('watchAd'); btn.disabled=true; btn.innerText="Loading Ad...";

    if (typeof window[AD_SDK_FN] === 'function') {
      try { await window[AD_SDK_FN]('pop'); await grantAdReward(); }
      catch(e){ console.error("ad fail",e); if (tg) tg.showAlert("Ad not completed"); }
    } else {
      // fallback simulate
      await new Promise(r=>setTimeout(r,1200));
      await grantAdReward();
    }
       btn.disabled=false; btn.innerText="Watch Rewarded Ad (+50)";
  } catch(e){ console.error(e); }
};

async function grantAdReward(){
  current.points += 50;
  current.adsToday = (current.adsToday || 0) + 1;
  const M = {10:500,20:1000,50:3000};
  if (M[current.adsToday] && !(current.adsMilestones||[]).includes(current.adsToday)){
    current.points += M[current.adsToday];
    current.adsMilestones = current.adsMilestones||[]; current.adsMilestones.push(current.adsToday);
  }
  await userDocRef().update({ points: current.points, adsToday: current.adsToday, adsMilestones: current.adsMilestones });
  updateUI();
  if (tg) tg.showAlert("+50 pts awarded");
}

/* --------- Mining (passive) --------- */
let mining=false;
document.getElementById('startMining').onclick = ()=>{
  if (mining) return; mining=true;
  setInterval(async ()=>{
    current.points = (current.points || 0) + 1;
    await userDocRef().update({ points: current.points }).catch(()=>{});
    updateUI();
  },1000);
};

/* -------- TON CONNECT setup (TonConnect UI) -------- */
let tonUI = null;
function setupTonConnect(){
  try {
    if (typeof TonConnectUI === 'undefined' && typeof window.TonConnectUI === 'undefined') {
      console.warn('TonConnect UI not loaded');
      return;
    }
    // prefer TonConnectUI class exposed by the bundle
    const TCU = window.TonConnectUI || TonConnectUI;
    tonUI = new TCU.TonConnectUI({
      manifestUrl: TON_MANIFEST_URL,
      // The UI will render a button in this container
      buttonRootId: 'tonConnectBtn'
    });

    tonUI.onStatusChange(async (walletInfo) => {
      try {
        // walletInfo example: { account: { address: 'EQ...' }, ... }
        if (walletInfo && walletInfo.account) {
          const tonAddr = walletInfo.account.address || walletInfo.account;
          current.tonWallet = tonAddr;
          await userDocRef().update({ tonWallet: tonAddr });
          document.getElementById('walletStatus').innerText = `TON: ${tonAddr.slice(0,6)}...${tonAddr.slice(-4)}`;
          if (tg) tg.showAlert("TON Wallet Connected");
          updateUI();
        }
      } catch(e){ console.error('ton onStatus err',e); }
    });
  } catch(e){ console.error('setupTonConnect err', e); if (tg) tg.showAlert('TON UI init failed'); }
}

/* Manual paste wallet fallback (user can paste EVM or TON address) */
document.getElementById('pasteWallet').onclick = async ()=>{
  try {
    const pasted = prompt("Paste wallet address (TON or EVM):");
    if (!pasted) return;
    const addr = pasted.trim();
    // naive validation: TON start with 'E' or '0:' or use 48 chars - we won't strictly validate here
    if (!addr || addr.length < 10) { alert('Invalid address'); return; }
    current.tonWallet = addr;
    await userDocRef().update({ tonWallet: addr });
    document.getElementById('walletStatus').innerText = `TON: ${addr.slice(0,6)}...${addr.slice(-4)}`;
    if (tg) tg.showAlert('Wallet saved');
  } catch(e){ console.error('paste err',e); if (tg) tg.showAlert('Error saving wallet'); }
};

/* Show balance (simple) */
document.getElementById('showBalance').onclick = async ()=>{
  try {
    const addr = current.tonWallet || current.wallet;
    if (!addr) return (tg ? tg.showAlert('Connect wallet first') : alert('Connect wallet first'));
    // For TON we don't fetch on-chain here (requires TON RPC). Just show saved address
    alert(`Address: ${addr}`);
  } catch(e){ console.error(e); if (tg) tg.showAlert('Error reading'); }
};

/* -------------- End of main script -------------- */

/* Firestore rules recommendation (use in Firebase console):
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null;
    }
  }
}
*/

</script>
</body>
</html>

