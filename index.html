<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AETHER PRO ‚Äî Elite Mining</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css"/>

<script src='//libtl.com/sdk.js' data-zone='10192178' data-sdk='show_10192178'></script>

<style>
/* --- ELITE EMERALD THEME APPLIED OVER YOUR CLASSES --- */
:root { 
    --bg: #05070a; 
    --card: #0d1117; 
    --accent: #00ffa3; 
    --text: #ffffff; 
    --muted: #8b949e; 
    --border: rgba(0, 255, 163, 0.2); 
    --glow: 0 0 15px rgba(0, 255, 163, 0.3); 
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg); color: var(--muted); min-height: 100vh; padding: 14px; overflow-x: hidden; }
.wrap { max-width: 720px; margin: 12px auto; }

/* Header */
.header { display: flex; gap: 12px; align-items: center; padding: 18px; border-radius: 20px; background: var(--card); border: 1px solid var(--border); box-shadow: var(--glow); }
.logo { width: 50px; height: 50px; border-radius: 14px; background: var(--accent); display: flex; align-items: center; justify-content: center; color: #000; font-weight: 900; position: relative; box-shadow: var(--glow); }
.logo::after { content: 'AE'; font-size: 20px; font-weight: 900; color: #000; }
.user-dp { width: 40px; height: 40px; border-radius: 50%; margin-left: auto; border: 2px solid var(--accent); }
h1 { color: var(--text); font-size: 18px; margin-bottom: 2px; font-weight: 800; letter-spacing: 0.5px; }
.sub { color: var(--accent); font-size: 11px; text-transform: uppercase; font-weight: 600; }

/* Main Card & Stats */
.card { background: transparent; margin-top: 15px; }
.stats { display: flex; gap: 10px; margin-bottom: 15px; }
.stat { flex: 1; padding: 16px 10px; background: var(--card); border: 1px solid var(--border); border-radius: 16px; text-align: center; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
.v { font-weight: 900; color: var(--text); font-size: 22px; margin-bottom: 4px; }
.l { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

/* Tabs */
.tabs { display: flex; gap: 8px; background: rgba(255,255,255,0.03); padding: 6px; border-radius: 16px; margin-bottom: 20px; }
.tab { flex: 1; padding: 12px; border-radius: 12px; text-align: center; cursor: pointer; color: var(--muted); font-weight: 700; font-size: 13px; transition: 0.3s; }
.tab.active { background: var(--card); color: var(--accent); border: 1px solid var(--border); box-shadow: var(--glow); }

/* Sections */
.section { display: none; background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); }
.section.active { display: block; animation: fadeIn 0.4s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Buttons */
.btn { width: 100%; padding: 16px; border-radius: 14px; border: none; background: var(--accent); color: #000; font-weight: 800; font-size: 15px; cursor: pointer; margin-top: 12px; transition: all 0.2s; box-shadow: 0 4px 15px rgba(0, 255, 163, 0.2); text-transform: uppercase; }
.btn:active { transform: scale(0.98); }
.btn.secondary { background: #1a1f2e; color: #fff; box-shadow: none; border: 1px solid rgba(255,255,255,0.1); }
.btn.attractive { background: linear-gradient(135deg, var(--accent), #00b373); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; background: #333; color: #777; }

/* Misc */
.small { font-size: 12px; color: var(--muted); margin-top: 10px; text-align: center; }
.ref-box { display: flex; flex-direction: column; gap: 10px; padding: 16px; border-radius: 16px; background: rgba(0, 255, 163, 0.05); border: 1px dashed var(--accent); margin-top: 15px; }
#myRef { word-break: break-all; padding: 12px; background: #000; border-radius: 10px; font-size: 11px; color: var(--accent); text-align: center; }

/* Levels */
.levels { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 15px; }
.level { padding: 15px; border-radius: 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); text-align: center; }
.claimBtn { background: var(--accent); color: #000; padding: 10px; border-radius: 10px; border: none; cursor: pointer; font-weight: 800; width: 100%; margin-top: 12px; transition: 0.3s; }
.claimBtn:disabled { background: #222; color: #555; }

/* Airdrop Status */
.airdrop-eligible { color: var(--accent); font-weight: 800; font-size: 14px; }
.airdrop-ineligible { color: #ff4444; font-weight: 800; font-size: 14px; }

/* Welcome Popup */
.welcome-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); color: #fff; padding: 30px 20px; border-radius: 24px; text-align: center; z-index: 1000; border: 1px solid var(--accent); box-shadow: var(--glow); width: 85%; max-width: 350px; }
.footer { margin-top: 30px; text-align: center; color: var(--muted); font-size: 11px; padding: 10px; }
</style>
</head>
<body>

<div class="wrap">
  <div class="header">
    <div class="logo"></div>
    <div>
      <h1>AETHER</h1>
      <div id="userLine" class="sub">Connecting...</div>
    </div>
    <img id="user-dp" class="user-dp" src="" alt="User DP" style="display:none">
  </div>

  <div class="card">
    <div class="stats">
      <div class="stat"><div class="v" id="points">0</div><div class="l">Coins</div></div>
      <div class="stat"><div class="v" id="refs">0</div><div class="l">Referrals</div></div>
      <div class="stat"><div class="v" id="level">1</div><div class="l">Level</div></div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="openTab('home')">Home</div>
      <div class="tab" onclick="openTab('tasks')">Earn</div>
      <div class="tab" onclick="openTab('referral')">Invite</div>
      <div class="tab" onclick="openTab('airdrop')">Airdrop</div>
      <div class="tab" id="adminTab" onclick="openTab('admin')" style="display:none">Admin</div>
    </div>

    <div id="home" class="section active">
      <button id="startMining" class="btn">Start Passive Earning</button>
      <p class="small">+1 coin every 2 seconds ‚Ä¢ Daily streak bonus</p>

      <div class="ref-box">
        <h3 style="color:var(--accent); font-size: 16px;">‚≠ê Official Channel</h3>
        <button id="openChannel" class="btn attractive">Join @kxearnig</button>
        <button id="officialBot" class="btn secondary">Official Bot Chat</button>
      </div>
    </div>

    <div id="tasks" class="section">
      <button id="watchAd" class="btn">Watch Ad (+500 Coins)</button>
      <p class="small">1 ad per 15 min ‚Ä¢ Total Ads Watched: <span id="totalAds" style="color:var(--text); font-weight:bold;">0</span></p>

      <div class="small" style="margin-top:25px;font-weight:800;color:var(--accent); font-size:14px;">LEVEL REWARDS</div>
      <div id="levelsList" class="levels"></div>
      <div style="text-align:center;margin-top:20px">
        <button id="showAllLevels" class="btn secondary">Load More Levels</button>
      </div>
    </div>

    <div id="referral" class="section">
      <div id="refStats" class="ref-stats" style="display:none;">Referrals: 0</div>
      <div style="text-align:center;">
        <h3 style="color:var(--accent);font-size:22px; margin-bottom: 5px;">Invite & Earn</h3>
        <p style="font-size: 13px; color: var(--muted);">Each referral = +5000 coins!</p>
        <div class="ref-box" style="margin-top: 20px;">
          <div style="font-size: 12px; font-weight: bold;">Your Unique Referral Link:</div>
          <div id="myRef">Generating...</div>
          <button id="copyRef" class="btn">COPY LINK</button>
        </div>
        <button id="officialBotRef" class="btn secondary" style="margin-top:15px">Official Bot Chat</button>
      </div>
    </div>

    <div id="airdrop" class="section">
      <div style="text-align:center;">
        <h3 style="color:var(--accent);font-size:22px;">TON Airdrop</h3>
        <p class="small" style="margin-bottom:20px">Stay active ‚Ä¢ Invite friends ‚Ä¢ Connect wallet</p>
        <div id="eligibilityMsg" class="small" style="margin-bottom:20px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;"></div>
        <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
          <button id="connectTon" class="btn">Connect TON Wallet</button>
          <button id="disconnectTon" class="btn secondary" style="display:none">Disconnect Wallet</button>
          <div id="tonBtnRoot"></div>
        </div>
        <p class="small" id="walletStatus" style="margin-top:16px; font-weight: bold;">Not Connected</p>
      </div>
    </div>

    <div id="admin" class="section">
      <div class="small" style="margin-top:10px;font-weight:800;color:var(--accent)">Users List</div>
      <div id="usersList" style="margin-top: 15px; font-size: 12px; background: #000; padding: 10px; border-radius: 10px; max-height: 200px; overflow-y: auto;"></div>
    </div>
  </div>

  <div class="footer">
    ¬© AETHER ‚Ä¢ Premium TON Project 2026
  </div>
</div>

<div id="welcome-popup" class="welcome-popup" style="display:none">
  <h2 style="color:var(--accent); margin-bottom: 10px;">Welcome to Aether!</h2>
  <p style="font-size: 14px; margin-bottom: 15px;">Earn coins, invite friends & get ready for TON airdrop üöÄ</p>
  <button class="btn secondary" onclick="tg.openTelegramLink('https://t.me/AetherMineXBot')" style="margin-bottom:10px">Chat with Bot</button>
  <button onclick="closeWelcome()" class="btn">Start Earning</button>
</div>

<script>
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBRMiyuGkjDFfZE9tqgzGVWJalw_6Cypz4",
  authDomain: "earncryptomp.firebaseapp.com",
  projectId: "earncryptomp",
  storageBucket: "earncryptomp.firebasestorage.app",
  messagingSenderId: "405204250643",
  appId: "1:405204250643:web:8841299bceb46f6752cfe6"
};
const AD_FN = 'show_10192178';
const ADS_COOLDOWN_MINUTES = 15;
const TON_MANIFEST = 'https://karangangani.github.io/Earncrypto/tonconnect-manifest.json';
const ADMIN_ID = '5973954829';
const REFERRAL_REWARD = 5000;

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
const auth = firebase.auth();

const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const tgUser = tg.initDataUnsafe.user || {};
let userDocId = null;
let current = {
  coins: 0, refs: [], level: 1, adsToday: 0, totalAds: 0, claimedLevels: [], tonWallet: '', lastAdTime: 0, lastResetDate: '', notificationsEnabled: false, username: '', botJoined: false
};
let tonUI = null;
let levelsRendered = 0;
let unsubscribeSnapshot = null;

const startParam = tg.initDataUnsafe.start_param || '';

function userRef() { return db.collection('users').doc(userDocId); }

async function initApp() {
  try {
    await auth.signInAnonymously();

    const tgId = tgUser.id ? tgUser.id.toString() : 'guest_' + Date.now();
    userDocId = tgId;

    let doc = await userRef().get();
    let isNewUser = !doc.exists;

    const username = tgUser.username || tgUser.first_name || 'User';
    current.username = username;

    if (isNewUser) {
      await userRef().set({
        coins: 20, refs: [], level: 1, adsToday: 0, totalAds: 0, claimedLevels: [], tonWallet: '', lastAdTime: 0, lastResetDate: new Date().toDateString(), notificationsEnabled: false, username: username
      });
    } else {
      const data = doc.data();
      Object.assign(current, data);
    }

    computeLevel();

    if (tgUser.photo_url) {
      document.getElementById('user-dp').src = tgUser.photo_url;
      document.getElementById('user-dp').style.display = 'block';
    }

    document.getElementById('userLine').innerText = current.username + ' ‚Ä¢ ID: ' + userDocId;

    unsubscribeSnapshot = userRef().onSnapshot(docSnap => {
      if (docSnap.exists) {
        Object.assign(current, docSnap.data());
        computeLevel();
        updateUI();
        updateLevelProgressUI();
        updateRefStats();
        updateAirdropEligibility();
        updateWalletButtons();
      }
    });

    // -------- THE ONLY LOGIC CHANGE: Pointed the link to the Bot --------
    const refLink = `https://t.me/AetherMineXBot?start=ref_${userDocId}`;
    // --------------------------------------------------------------------
    
    document.getElementById('myRef').innerText = refLink;
    document.getElementById('copyRef').onclick = () => {
      navigator.clipboard.writeText(refLink);
      tg.showAlert('Link Copied! Share this with your friends.');
    };

    // Official Bot/Channel buttons
    document.getElementById('officialBot').onclick = () => tg.openTelegramLink('https://t.me/AetherMineXBot');
        document.getElementById('officialBotRef').onclick = () => tg.openTelegramLink('https://t.me/AetherMineXBot');
    document.getElementById('openChannel').onclick = () => tg.openTelegramLink('https://t.me/kxearnig');

    // Referral handling
    if (startParam && startParam.startsWith('ref_')) {
      await handleReferral(startParam);
    }

    // Admin tab
    if (userDocId === ADMIN_ID) {
      document.getElementById('adminTab').style.display = 'block';
      loadUsersList();
    }

    tonUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: TON_MANIFEST, buttonRootId: 'tonBtnRoot' });
    tonUI.onStatusChange(async (wallet) => {
      if (wallet && wallet.account && wallet.account.address) {
        await trySaveTonWallet(wallet.account.address);
      } else {
        await userRef().update({ tonWallet: '' });
        current.tonWallet = '';
        updateUI();
        updateWalletButtons();
      }
    });
    
    document.getElementById('disconnectTon').onclick = async () => {
      await tonUI.disconnect();
      await userRef().update({ tonWallet: '' });
      current.tonWallet = '';
      updateUI();
      updateWalletButtons();
      tg.showAlert('Wallet disconnected!');
    };
    
    document.getElementById('watchAd').onclick = watchAdHandler;
    document.getElementById('startMining').onclick = startPassiveMining;
    document.getElementById('showAllLevels').onclick = () => renderLevelsChunk(50);

    renderLevelsChunk(20);
    await resetDailyAdsIfNeeded();
    updateUI();
    updateRefStats();
    updateAirdropEligibility();
    updateWalletButtons();

    setTimeout(() => {
      document.getElementById('welcome-popup').style.display = 'block';
    }, 500);

  } catch (e) {
    console.error(e);
    tg.showAlert('Error connecting. Please retry.');
  }
}

async function handleReferral(param) {
  const referrerId = param.replace('ref_', '');
  if (!referrerId || referrerId === userDocId) return;

  try {
    const doc = await userRef().get();
    if (doc.exists && doc.data().refs && doc.data().refs.includes(referrerId)) {
      return;
    }

    await userRef().set({ 
      refs: firebase.firestore.FieldValue.arrayUnion(referrerId) 
    }, { merge: true });

    await db.collection('users').doc(referrerId).update({
      refs: firebase.firestore.FieldValue.arrayUnion(userDocId),
      coins: firebase.firestore.FieldValue.increment(REFERRAL_REWARD)
    });

    if (!current.refs) current.refs = [];
    if (!current.refs.includes(referrerId)) {
      current.refs.push(referrerId);
    }

    computeLevel();
    updateUI();
    updateRefStats();
    tg.showAlert('Referral Done! Referrer Got +5000 Coins!');

  } catch (e) {
    console.error(e);
  }
}

function updateRefStats() {
  const refCount = current.refs ? current.refs.length : 0;
  const statsEl = document.getElementById('refStats');
  statsEl.style.display = 'block';
  statsEl.innerText = 'Total Referrals: ' + refCount;
}

async function loadUsersList() {
  const usersList = document.getElementById('usersList');
  usersList.innerHTML = 'Loading...';
  const snapshot = await db.collection('users').get();
  let html = '';
  snapshot.docs.forEach(doc => {
    const data = doc.data();
    html += '<div style="border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px;"><strong>' + data.username + '</strong> (ID: ' + doc.id + ')<br>Coins: ' + (data.coins || 0) + ' | Refs: ' + (data.refs?.length || 0) + '</div>';
  });
  usersList.innerHTML = html || 'No users yet.';
}

function computeLevel() {
  const refsCount = current.refs?.length || 0;
  const adsCount = current.totalAds || 0;
  current.level = Math.min(refsCount, adsCount) + 1;
}

function updateWalletButtons() {
  const connected = !!current.tonWallet;
  document.getElementById('connectTon').style.display = connected ? 'none' : 'block';
  document.getElementById('disconnectTon').style.display = connected ? 'block' : 'none';
  document.getElementById('walletStatus').innerText = connected 
    ? 'Connected: ' + current.tonWallet.slice(0,6) + '...' + current.tonWallet.slice(-4)
    : 'Not Connected';
}

function updateAirdropEligibility() {
  const msgEl = document.getElementById('eligibilityMsg');
  if (current.level >= 3) {
    msgEl.innerHTML = '<span class="airdrop-eligible">Eligible for Airdrop! Complete more levels for a bigger share.</span>';
  } else {
    msgEl.innerHTML = '<span class="airdrop-ineligible">You are not eligible for airdrop yet. Complete Level 3.</span>';
  }
}

function closeWelcome() {
  document.getElementById('welcome-popup').style.display = 'none';
}

async function resetDailyAdsIfNeeded() {
  const today = new Date().toDateString();
  if (current.lastResetDate !== today) {
    await userRef().update({ adsToday: 0, lastResetDate: today });
    current.adsToday = 0;
    current.lastResetDate = today;
    computeLevel();
  }
}

function updateUI() {
  document.getElementById('points').innerText = Math.floor(current.coins || 0);
  document.getElementById('refs').innerText = current.refs?.length || 0;
  document.getElementById('level').innerText = current.level || 1;
  document.getElementById('totalAds').innerText = current.totalAds || 0;
  updateWalletButtons();
}

function openTab(tab) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
}

let mining = false;
function startPassiveMining() {
  if (mining) return tg.showAlert('Already mining!');
  mining = true;
  document.getElementById('startMining').innerText = 'Mining Active...';
  document.getElementById('startMining').classList.add('secondary');
  
  setInterval(async () => {
    if (!mining) return;
    await userRef().update({ coins: firebase.firestore.FieldValue.increment(1) });
    current.coins += 1;
    updateUI();
  }, 2000);
  tg.showAlert('Passive mining started!');
}

async function watchAdHandler() {
  await resetDailyAdsIfNeeded();

  const now = Date.now();

  if (current.lastAdTime && (now - current.lastAdTime < ADS_COOLDOWN_MINUTES * 60 * 1000)) {
    const minutesLeft = Math.ceil((ADS_COOLDOWN_MINUTES * 60 * 1000 - (now - current.lastAdTime)) / 60000);
    return tg.showAlert('Wait ' + minutesLeft + ' minutes for next ad');
  }

  const btn = document.getElementById('watchAd');
  btn.disabled = true;
  btn.innerText = 'Loading...';

  try {
    if (typeof window[AD_FN] === 'function') await window[AD_FN]('pop');
    else await new Promise(r => setTimeout(r, 1500)); // Your exact fallback!

    const reward = 500;
    await userRef().update({
      coins: firebase.firestore.FieldValue.increment(reward),
      totalAds: firebase.firestore.FieldValue.increment(1),
      lastAdTime: now
    });
    current.coins += reward;
    current.totalAds += 1;
    current.lastAdTime = now;
    computeLevel();
    updateUI();
    tg.showAlert('+' + reward + ' coins!');
  } catch (e) {
    tg.showAlert('Ad not completed or failed to load.');
  }
  btn.disabled = false;
  btn.innerText = 'Watch Ad (+500 Coins)';
}

async function trySaveTonWallet(addr) {
  await userRef().update({ tonWallet: addr });
  current.tonWallet = addr;
  updateUI();
  updateWalletButtons();
  tg.showAlert('Wallet connected!');
}

function renderLevelsChunk(max) {
  const container = document.getElementById('levelsList');
  const start = levelsRendered + 1;
  const end = Math.min(100, levelsRendered + max);
  for (let i = start; i <= end; i++) {
    const refsNeeded = i;
    const adsNeeded = i;
    const reward = 500 * i;
    const el = document.createElement('div');
    el.className = 'level';
    el.innerHTML = '<div style="font-weight:900; color:var(--accent); font-size:16px;">Level ' + i + '</div>' +
                   '<div class="small">Requires: ' + refsNeeded + ' ref & ' + adsNeeded + ' ad</div>' +
                   '<div class="small" style="color:var(--text);">Reward: ' + reward + ' coins</div>' +
                   '<button id="claim_' + i + '" class="claimBtn" disabled>Claim</button>';
    container.appendChild(el);
    document.getElementById('claim_' + i).onclick = () => claimLevel(i, refsNeeded, adsNeeded, reward);
  }
  levelsRendered = end;
  updateLevelProgressUI();
}
async function updateLevelProgressUI() {
  const refsCount = current.refs?.length || 0;
  const adsDone = current.totalAds || 0;
  for (let i = 1; i <= levelsRendered; i++) {
    const btn = document.getElementById('claim_' + i);
    if (!btn) continue;
    const refsNeeded = i;
    const adsNeeded = i;
    const claimed = current.claimedLevels?.includes(i);
    btn.disabled = claimed || !(refsCount >= refsNeeded && adsDone >= adsNeeded);
    btn.innerText = claimed ? 'Claimed ‚úì' : 'Claim';
  }
}

async function claimLevel(levelNo, refsNeeded, adsNeeded, reward) {
  const refsCount = current.refs?.length || 0;
  const adsDone = current.totalAds || 0;
  if (refsCount < refsNeeded || adsDone < adsNeeded) return tg.showAlert('Requirements not met');
  if (current.claimedLevels?.includes(levelNo)) return tg.showAlert('Already claimed');
  await userRef().update({
    coins: firebase.firestore.FieldValue.increment(reward),
    claimedLevels: firebase.firestore.FieldValue.arrayUnion(levelNo)
  });
  current.coins += reward;
  current.claimedLevels.push(levelNo);
  updateUI();
  tg.showAlert('Level ' + levelNo + ' claimed! +' + reward + ' coins!');
}

initApp();
</script>
</body>
</html>
